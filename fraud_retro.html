<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Retro - Vietravel Loyalty</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            overflow-x: hidden;
        }

        .container {
            padding: 20px;
            max-width: 1405px;
            margin: 0 auto;
        }

        /* Header Actions */
        .header-actions {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        .btn-success:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-subtitle {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .stat-trend {
            display: inline-block;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .trend-up {
            background: #d4edda;
            color: #155724;
        }

        .trend-down {
            background: #f8d7da;
            color: #721c24;
        }

        /* Filter Bar */
        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }

        .filter-label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
        }

        .filter-select, .filter-input {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }

        .filter-input {
            min-width: 250px;
        }

        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Main Table */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .table-stats {
            font-size: 14px;
            color: #6c757d;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 450px;
            overflow-y: auto;
        }

        .retro-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .retro-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .retro-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }

        .retro-table tbody tr {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .retro-table tbody tr:hover {
            background: #f8f9fa;
        }

        /* Status Pills */
        .status-pill {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .status-processed { background: #d1ecf1; color: #0c5460; }

        /* Request Type Badges */
        .type-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .type-member { background: #e3f2fd; color: #1565c0; }
        .type-staff { background: #f3e5f5; color: #6a1b9a; }

        /* Transaction Type Badges */
        .trans-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .trans-tour { background: #d4edda; color: #155724; }
        .trans-flight { background: #d1ecf1; color: #0c5460; }
        .trans-hotel { background: #fff3cd; color: #856404; }
        .trans-other { background: #e9ecef; color: #495057; }

        /* Member Tier */
        .tier-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .tier-member { background: #e9ecef; color: #495057; }
        .tier-silver { background: #e0e0e0; color: #424242; }
        .tier-gold { background: #ffd700; color: #333; }
        .tier-platinum { background: #e5e4e2; color: #333; }

        /* Points Badge */
        .points-badge {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 12px;
            display: inline-block;
        }

        .points-diff {
            margin-left: 5px;
            font-size: 10px;
            color: #e74c3c;
        }

        /* Action Icons */
        .action-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #dee2e6;
            background: white;
        }

        .action-icon:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 5px;
        }

        .modal-body {
            padding: 20px;
        }

        /* Info Sections */
        .info-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-size: 11px;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
        }

        .info-value {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 500;
        }

        /* Document Viewer */
        .document-viewer {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .document-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .document-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .document-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .document-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .document-name {
            font-size: 11px;
            color: #6c757d;
            word-break: break-all;
        }

        /* Processing Log */
        .log-timeline {
            position: relative;
            padding-left: 30px;
        }

        .log-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }

        .log-entry {
            position: relative;
            padding: 10px 15px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .log-entry::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 15px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #3498db;
            border: 2px solid white;
        }

        .log-time {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .log-user {
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .log-action {
            font-size: 13px;
            color: #495057;
        }

        /* Processing Actions */
        .processing-section {
            border-top: 2px solid #e9ecef;
            padding-top: 20px;
            margin-top: 20px;
        }

        .processing-note {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
            resize: vertical;
        }

        /* Custom Scrollbar */
        .table-wrapper::-webkit-scrollbar,
        .modal-content::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .table-wrapper::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .table-wrapper::-webkit-scrollbar-thumb,
        .modal-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Actions -->
        <div class="header-actions">
            <h1 class="page-title">🔍 Quản lý Retro (Yêu cầu cộng điểm bổ sung)</h1>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="handleBulkApprove()">
                    ✅ Duyệt hàng loạt
                </button>
                <button class="btn btn-secondary" onclick="exportRetros()">
                    📥 Export CSV
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Tổng yêu cầu</div>
                <div class="stat-value" id="totalRequests">0</div>
                <div class="stat-subtitle">
                    <span class="stat-trend trend-up">+12%</span>
                    so với tháng trước
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Chờ duyệt</div>
                <div class="stat-value" style="color: #f39c12;" id="pendingCount">0</div>
                <div class="stat-subtitle">Cần xử lý ngay</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Đã duyệt</div>
                <div class="stat-value" style="color: #27ae60;" id="approvedCount">0</div>
                <div class="stat-subtitle">Tỷ lệ duyệt: <strong id="approvalRate">0%</strong></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Tổng điểm đã cộng</div>
                <div class="stat-value">2.5M</div>
                <div class="stat-subtitle">Tháng này: 450K điểm</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-row">
                <div class="filter-group" style="flex: 1;">
                    <label class="filter-label">Tìm kiếm</label>
                    <input type="text" class="filter-input" id="searchInput" 
                           placeholder="Tên HV / Mã HV / Email / SĐT / Mã giao dịch..." 
                           onkeyup="filterRetros()">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Người gửi</label>
                    <select class="filter-select" id="senderFilter" onchange="filterRetros()">
                        <option value="">Tất cả</option>
                        <option value="Hội viên">Hội viên</option>
                        <option value="Nhân viên CSKH">Nhân viên</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Trạng thái</label>
                    <select class="filter-select" id="statusFilter" onchange="filterRetros()">
                        <option value="">Tất cả</option>
                        <option value="Chờ duyệt">Chờ duyệt</option>
                        <option value="Đã duyệt">Đã duyệt</option>
                        <option value="Từ chối">Từ chối</option>
                        <option value="Đã xử lý">Đã xử lý</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Khoảng thời gian</label>
                    <div class="date-range">
                        <input type="date" class="filter-select" id="startDate" onchange="filterRetros()">
                        <span>-</span>
                        <input type="date" class="filter-select" id="endDate" onchange="filterRetros()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Table -->
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Danh sách yêu cầu Retro</h3>
                <div class="table-stats" id="tableStats">Hiển thị 0 yêu cầu</div>
            </div>
            <div class="table-wrapper">
                <table class="retro-table">
                    <thead>
                        <tr>
                            <th width="30">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th width="100">Mã yêu cầu</th>
                            <th width="150">Thời gian yêu cầu</th>
                            <th width="100">Người gửi</th>
                            <th width="200">Hội viên liên quan</th>
                            <th width="120">Giao dịch yêu cầu</th>
                            <th width="100">Loại GD</th>
                            <th width="120">Giá trị GD</th>
                            <th width="120">Điểm đề nghị</th>
                            <th width="120">Điểm hệ thống</th>
                            <th width="100">Trạng thái</th>
                            <th width="80">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="retroTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Chi tiết yêu cầu Retro</h2>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be dynamically loaded -->
            </div>
        </div>
    </div>

    <script>
        // Generate sample data from CSV description
        const retroData = generateRetroData();
        let filteredData = [...retroData];

        function generateRetroData() {
            const data = [];
            const senders = ['Hội viên', 'Nhân viên CSKH'];
            const tiers = ['Member', 'Silver', 'Gold', 'Platinum'];
            const transTypes = ['Tour du lịch', 'Vé máy bay', 'Khách sạn', 'Dịch vụ khác'];
            const statuses = ['Chờ duyệt', 'Đã duyệt', 'Từ chối', 'Đã xử lý'];
            const firstNames = ['Nguyễn', 'Trần', 'Lê', 'Phạm', 'Hoàng', 'Vũ', 'Võ', 'Đặng', 'Bùi', 'Đỗ'];
            const middleNames = ['Văn', 'Thị', 'Hoàng', 'Minh', 'Thanh', 'Quốc', 'Đức', 'Thành'];
            const lastNames = ['An', 'Bình', 'Cường', 'Dũng', 'Hòa', 'Khang', 'Long', 'Minh', 'Nam', 'Phúc'];

            for (let i = 1; i <= 100; i++) {
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const transType = transTypes[Math.floor(Math.random() * transTypes.length)];
                const value = Math.floor(Math.random() * 50000000) + 1000000;
                const suggestedPoints = Math.floor(value / 100000);
                const systemPoints = Math.floor(suggestedPoints * (0.8 + Math.random() * 0.3));
                
                // Generate random date in last 30 days
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                
                const fullName = `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${middleNames[Math.floor(Math.random() * middleNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`;
                
                data.push({
                    'Mã yêu cầu': `RETRO-2025-${String(i).padStart(5, '0')}`,
                    'Người yêu cầu': senders[Math.floor(Math.random() * senders.length)],
                    'Thời gian tạo': date.toISOString().replace('T', ' ').substr(0, 16),
                    'Họ tên HV': fullName,
                    'Mã HV': `HV${String(Math.floor(Math.random() * 99999) + 10000).padStart(5, '0')}`,
                    'Hạng HV': tiers[Math.floor(Math.random() * tiers.length)],
                    'Loại giao dịch': transType,
                    'Mã giao dịch': transType === 'Tour du lịch' ? `T${Math.floor(Math.random() * 99999) + 10000}` :
                                    transType === 'Vé máy bay' ? `VN${Math.floor(Math.random() * 999) + 100}` :
                                    transType === 'Khách sạn' ? `HTL${Math.floor(Math.random() * 9999) + 1000}` :
                                    `SRV${Math.floor(Math.random() * 9999) + 1000}`,
                    'Ngày giao dịch': new Date(date.getTime() - Math.floor(Math.random() * 7 * 24 * 60 * 60 * 1000)).toISOString().substr(0, 10),
                    'Giá trị giao dịch': value,
                    'Điểm đề nghị cộng': suggestedPoints,
                    'Điểm hệ thống tính': systemPoints,
                    'Trạng thái': status,
                    'Ghi chú xử lý': status === 'Đã duyệt' ? 'Chứng từ hợp lệ, đã cộng điểm' :
                                     status === 'Từ chối' ? 'Chứng từ không hợp lệ' :
                                     status === 'Đã xử lý' ? 'Đã xử lý và cộng điểm' : ''
                });
            }
            
            // Sort by date descending
            data.sort((a, b) => new Date(b['Thời gian tạo']) - new Date(a['Thời gian tạo']));
            
            return data;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadRetros();
            updateStats();
        });

        // Load retros to table
        function loadRetros() {
            const tbody = document.getElementById('retroTableBody');
            tbody.innerHTML = '';

            filteredData.forEach(retro => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="row-select" value="${retro['Mã yêu cầu']}"></td>
                    <td><strong>${retro['Mã yêu cầu']}</strong></td>
                    <td>${formatDateTime(retro['Thời gian tạo'])}</td>
                    <td>${getSenderBadge(retro['Người yêu cầu'])}</td>
                    <td>
                        <div><strong>${retro['Họ tên HV']}</strong></div>
                        <div style="font-size: 11px; color: #6c757d;">
                            ${retro['Mã HV']} - ${getTierBadge(retro['Hạng HV'])}
                        </div>
                    </td>
                    <td><code>${retro['Mã giao dịch']}</code></td>
                    <td>${getTransTypeBadge(retro['Loại giao dịch'])}</td>
                    <td><strong>${formatCurrency(retro['Giá trị giao dịch'])}</strong></td>
                    <td>
                        <span class="points-badge">${retro['Điểm đề nghị cộng'].toLocaleString()}</span>
                    </td>
                    <td>
                        ${retro['Điểm hệ thống tính'].toLocaleString()}
                        ${retro['Điểm đề nghị cộng'] !== retro['Điểm hệ thống tính'] ? 
                            `<span class="points-diff">(${retro['Điểm đề nghị cộng'] > retro['Điểm hệ thống tính'] ? '+' : ''}${retro['Điểm đề nghị cộng'] - retro['Điểm hệ thống tính']})</span>` : ''}
                    </td>
                    <td>${getStatusBadge(retro['Trạng thái'])}</td>
                    <td>
                        <span class="action-icon" onclick="viewDetail('${retro['Mã yêu cầu']}')" title="Xem chi tiết">👁️</span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('tableStats').textContent = `Hiển thị ${filteredData.length} yêu cầu`;
        }

        // Format date time
        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return `<div>${date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</div>
                    <div style="font-size: 11px; color: #6c757d;">${date.toLocaleDateString('vi-VN')}</div>`;
        }

        // Format currency
        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN') + ' đ';
        }

        // Get sender badge
        function getSenderBadge(sender) {
            const typeClass = sender === 'Hội viên' ? 'type-member' : 'type-staff';
            return `<span class="type-badge ${typeClass}">${sender}</span>`;
        }

        // Get tier badge
        function getTierBadge(tier) {
            const tierClass = 'tier-' + tier.toLowerCase();
            return `<span class="tier-badge ${tierClass}">${tier}</span>`;
        }

        // Get transaction type badge
        function getTransTypeBadge(type) {
            const typeMap = {
                'Tour du lịch': 'trans-tour',
                'Vé máy bay': 'trans-flight',
                'Khách sạn': 'trans-hotel',
                'Dịch vụ khác': 'trans-other'
            };
            return `<span class="trans-badge ${typeMap[type] || 'trans-other'}">${type}</span>`;
        }

        // Get status badge
        function getStatusBadge(status) {
            const statusMap = {
                'Chờ duyệt': 'status-pending',
                'Đã duyệt': 'status-approved',
                'Từ chối': 'status-rejected',
                'Đã xử lý': 'status-processed'
            };
            return `<span class="status-pill ${statusMap[status] || ''}">${status}</span>`;
        }

        // Filter retros
        function filterRetros() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const senderFilter = document.getElementById('senderFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            filteredData = retroData.filter(retro => {
                // Search filter
                if (searchTerm) {
                    const searchFields = [
                        retro['Họ tên HV'],
                        retro['Mã HV'],
                        retro['Mã giao dịch'],
                        retro['Mã yêu cầu']
                    ].join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchTerm)) {
                        return false;
                    }
                }

                // Sender filter
                if (senderFilter && retro['Người yêu cầu'] !== senderFilter) {
                    return false;
                }

                // Status filter
                if (statusFilter && retro['Trạng thái'] !== statusFilter) {
                    return false;
                }

                // Date range filter
                if (startDate || endDate) {
                    const retroDate = new Date(retro['Thời gian tạo']);
                    if (startDate && retroDate < new Date(startDate)) return false;
                    if (endDate && retroDate > new Date(endDate + ' 23:59:59')) return false;
                }

                return true;
            });

            loadRetros();
            updateStats();
        }

        // Update statistics
        function updateStats() {
            const total = retroData.length;
            const pending = retroData.filter(r => r['Trạng thái'] === 'Chờ duyệt').length;
            const approved = retroData.filter(r => r['Trạng thái'] === 'Đã duyệt').length;
            const processed = retroData.filter(r => r['Trạng thái'] === 'Đã xử lý').length;

            document.getElementById('totalRequests').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedCount').textContent = approved + processed;
            document.getElementById('approvalRate').textContent = 
                Math.round((approved + processed) / total * 100) + '%';
        }

        // View detail
        function viewDetail(requestId) {
            const retro = retroData.find(r => r['Mã yêu cầu'] === requestId);
            if (!retro) return;

            document.getElementById('modalTitle').textContent = `Chi tiết yêu cầu ${requestId}`;
            
            const isPending = retro['Trạng thái'] === 'Chờ duyệt';
            const pointsDiff = retro['Điểm đề nghị cộng'] - retro['Điểm hệ thống tính'];

            document.getElementById('modalBody').innerHTML = `
                <!-- Request Info -->
                <div class="info-section">
                    <h3 class="info-section-title">📋 Thông tin yêu cầu</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Mã yêu cầu</span>
                            <span class="info-value">${retro['Mã yêu cầu']}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Người yêu cầu</span>
                            <span class="info-value">${getSenderBadge(retro['Người yêu cầu'])}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Thời gian tạo</span>
                            <span class="info-value">${new Date(retro['Thời gian tạo']).toLocaleString('vi-VN')}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Trạng thái</span>
                            <span class="info-value">${getStatusBadge(retro['Trạng thái'])}</span>
                        </div>
                    </div>
                </div>

                <!-- Member Info -->
                <div class="info-section">
                    <h3 class="info-section-title">👤 Thông tin hội viên</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Họ tên</span>
                            <span class="info-value">${retro['Họ tên HV']}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Mã hội viên</span>
                            <span class="info-value">${retro['Mã HV']}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Hạng hội viên</span>
                            <span class="info-value">${getTierBadge(retro['Hạng HV'])}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email</span>
                            <span class="info-value">${retro['Mã HV'].toLowerCase()}@email.com</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="alert('Xem lịch sử hội viên ${retro['Mã HV']}')">
                            📊 Xem lịch sử hội viên
                        </button>
                    </div>
                </div>

                <!-- Transaction Info -->
                <div class="info-section">
                    <h3 class="info-section-title">💳 Thông tin giao dịch</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Loại giao dịch</span>
                            <span class="info-value">${getTransTypeBadge(retro['Loại giao dịch'])}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Mã giao dịch</span>
                            <span class="info-value"><code>${retro['Mã giao dịch']}</code></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ngày giao dịch</span>
                            <span class="info-value">${new Date(retro['Ngày giao dịch']).toLocaleDateString('vi-VN')}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Giá trị giao dịch</span>
                            <span class="info-value" style="font-size: 18px; font-weight: bold; color: #2c3e50;">
                                ${formatCurrency(retro['Giá trị giao dịch'])}
                            </span>
                        </div>
                    </div>
                    <div class="info-grid" style="margin-top: 15px; background: white; padding: 15px; border-radius: 8px;">
                        <div class="info-item">
                            <span class="info-label">Điểm đề nghị cộng</span>
                            <span class="info-value">
                                <span class="points-badge" style="font-size: 16px;">
                                    ${retro['Điểm đề nghị cộng'].toLocaleString()} điểm
                                </span>
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Điểm hệ thống tính</span>
                            <span class="info-value" style="font-size: 16px;">
                                ${retro['Điểm hệ thống tính'].toLocaleString()} điểm
                                ${pointsDiff !== 0 ? 
                                    `<span class="points-diff">(Chênh lệch: ${pointsDiff > 0 ? '+' : ''}${pointsDiff})</span>` : ''}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Documents -->
                <div class="info-section">
                    <h3 class="info-section-title">📎 Chứng từ đính kèm</h3>
                    <div class="document-grid">
                        <div class="document-item" onclick="alert('Xem hóa đơn')">
                            <div class="document-icon">📄</div>
                            <div class="document-name">hoadon_${retro['Mã giao dịch']}.pdf</div>
                        </div>
                        ${retro['Loại giao dịch'] === 'Vé máy bay' ? `
                            <div class="document-item" onclick="alert('Xem boarding pass')">
                                <div class="document-icon">✈️</div>
                                <div class="document-name">boarding_pass.jpg</div>
                            </div>
                        ` : ''}
                        <div class="document-item" onclick="alert('Xem biên lai')">
                            <div class="document-icon">🧾</div>
                            <div class="document-name">bienlai_thanhtoan.jpg</div>
                        </div>
                    </div>
                </div>

                <!-- Processing Log -->
                <div class="info-section">
                    <h3 class="info-section-title">📝 Nhật ký xử lý</h3>
                    <div class="log-timeline">
                        ${generateProcessingLog(retro)}
                    </div>
                </div>

                <!-- Processing Actions (only for pending) -->
                ${isPending ? `
                    <div class="processing-section">
                        <h3 class="info-section-title">⚙️ Xử lý yêu cầu</h3>
                        <div>
                            <label style="font-size: 13px; color: #6c757d; font-weight: 600;">Ghi chú xử lý:</label>
                            <textarea class="processing-note" id="processingNote" 
                                      placeholder="Nhập ghi chú xử lý..."></textarea>
                        </div>
                        <div class="action-buttons" style="justify-content: space-between;">
                            <button class="btn btn-secondary" onclick="requestMoreDocs()">
                                📋 Yêu cầu bổ sung
                            </button>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-danger" onclick="rejectRequest('${requestId}')">
                                    ❌ Từ chối
                                </button>
                                <button class="btn btn-success" onclick="approveRequest('${requestId}')">
                                    ✅ Duyệt yêu cầu
                                </button>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;

            document.getElementById('detailModal').classList.add('active');
        }

        // Generate processing log
        function generateProcessingLog(retro) {
            let log = `
                <div class="log-entry">
                    <div class="log-time">${new Date(retro['Thời gian tạo']).toLocaleString('vi-VN')}</div>
                    <div class="log-user">${retro['Người yêu cầu']}</div>
                    <div class="log-action">Tạo yêu cầu retro</div>
                </div>
            `;

            if (retro['Trạng thái'] !== 'Chờ duyệt') {
                const processDate = new Date(retro['Thời gian tạo']);
                processDate.setHours(processDate.getHours() + Math.floor(Math.random() * 48) + 1);
                
                log += `
                    <div class="log-entry">
                        <div class="log-time">${processDate.toLocaleString('vi-VN')}</div>
                        <div class="log-user">Admin CSKH</div>
                        <div class="log-action">
                            ${retro['Trạng thái'] === 'Đã duyệt' ? 'Đã duyệt và cộng điểm' :
                              retro['Trạng thái'] === 'Từ chối' ? 'Đã từ chối yêu cầu' :
                              'Đã xử lý yêu cầu'}
                            ${retro['Ghi chú xử lý'] ? `<div style="margin-top: 5px; font-size: 12px; color: #6c757d;">"${retro['Ghi chú xử lý']}"</div>` : ''}
                        </div>
                    </div>
                `;
            }

            return log;
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // Approve request
        function approveRequest(requestId) {
            const note = document.getElementById('processingNote').value;
            if (!note) {
                alert('Vui lòng nhập ghi chú xử lý!');
                return;
            }

            if (confirm('Bạn có chắc muốn duyệt yêu cầu này?')) {
                const retro = retroData.find(r => r['Mã yêu cầu'] === requestId);
                if (retro) {
                    retro['Trạng thái'] = 'Đã duyệt';
                    retro['Ghi chú xử lý'] = note;
                    alert(`Đã duyệt yêu cầu ${requestId} và cộng ${retro['Điểm hệ thống tính'].toLocaleString()} điểm cho hội viên ${retro['Mã HV']}`);
                    closeModal();
                    filterRetros();
                }
            }
        }

        // Reject request
        function rejectRequest(requestId) {
            const note = document.getElementById('processingNote').value;
            if (!note) {
                alert('Vui lòng nhập lý do từ chối!');
                return;
            }

            if (confirm('Bạn có chắc muốn từ chối yêu cầu này?')) {
                const retro = retroData.find(r => r['Mã yêu cầu'] === requestId);
                if (retro) {
                    retro['Trạng thái'] = 'Từ chối';
                    retro['Ghi chú xử lý'] = note;
                    alert(`Đã từ chối yêu cầu ${requestId}`);
                    closeModal();
                    filterRetros();
                }
            }
        }

        // Request more documents
        function requestMoreDocs() {
            const note = document.getElementById('processingNote').value;
            if (!note) {
                alert('Vui lòng nhập yêu cầu bổ sung!');
                return;
            }
            alert('Đã gửi yêu cầu bổ sung chứng từ đến hội viên');
        }

        // Toggle select all
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            document.querySelectorAll('.row-select').forEach(cb => {
                cb.checked = selectAll;
            });
        }

        // Handle bulk approve
        function handleBulkApprove() {
            const selected = document.querySelectorAll('.row-select:checked');
            if (selected.length === 0) {
                alert('Vui lòng chọn ít nhất một yêu cầu!');
                return;
            }

            if (confirm(`Bạn có chắc muốn duyệt ${selected.length} yêu cầu đã chọn?`)) {
                let approvedCount = 0;
                selected.forEach(cb => {
                    const requestId = cb.value;
                    const retro = retroData.find(r => r['Mã yêu cầu'] === requestId);
                    if (retro && retro['Trạng thái'] === 'Chờ duyệt') {
                        retro['Trạng thái'] = 'Đã duyệt';
                        retro['Ghi chú xử lý'] = 'Duyệt hàng loạt';
                        approvedCount++;
                    }
                });
                alert(`Đã duyệt thành công ${approvedCount} yêu cầu!`);
                filterRetros();
            }
        }

        // Export retros
        function exportRetros() {
            alert('Xuất file CSV danh sách yêu cầu retro');
        }
    </script>
</body>
</html>