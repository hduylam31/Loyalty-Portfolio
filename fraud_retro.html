<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Retro - Vietravel Loyalty</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            overflow-x: hidden;
        }

        .container {
            padding: 20px;
            max-width: 1405px;
            margin: 0 auto;
        }

        /* Header Actions */
        .header-actions {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        .btn-success:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-subtitle {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .stat-trend {
            display: inline-block;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .trend-up {
            background: #d4edda;
            color: #155724;
        }

        .trend-down {
            background: #f8d7da;
            color: #721c24;
        }

        /* Filter Bar */
        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }

        .filter-label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
        }

        .filter-select, .filter-input {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }

        .filter-input {
            min-width: 250px;
        }

        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Main Table */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .table-stats {
            font-size: 14px;
            color: #6c757d;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 450px;
            overflow-y: auto;
        }

        .retro-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .retro-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .retro-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }

        .retro-table tbody tr {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .retro-table tbody tr:hover {
            background: #f8f9fa;
        }

        /* Status Pills */
        .status-pill {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .status-processed { background: #d1ecf1; color: #0c5460; }

        /* Request Type Badges */
        .type-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .type-member { background: #e3f2fd; color: #1565c0; }
        .type-staff { background: #f3e5f5; color: #6a1b9a; }

        /* Transaction Type Badges */
        .trans-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .trans-tour { background: #d4edda; color: #155724; }
        .trans-flight { background: #d1ecf1; color: #0c5460; }
        .trans-hotel { background: #fff3cd; color: #856404; }
        .trans-other { background: #e9ecef; color: #495057; }

        /* Member Tier */
        .tier-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .tier-member { background: #e9ecef; color: #495057; }
        .tier-silver { background: #e0e0e0; color: #424242; }
        .tier-gold { background: #ffd700; color: #333; }
        .tier-platinum { background: #e5e4e2; color: #333; }

        /* Points Badge */
        .points-badge {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 12px;
            display: inline-block;
        }

        .points-diff {
            margin-left: 5px;
            font-size: 10px;
            color: #e74c3c;
        }

        /* Action Icons */
        .action-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #dee2e6;
            background: white;
        }

        .action-icon:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 5px;
        }

        .modal-body {
            padding: 20px;
        }

        /* Info Sections */
        .info-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-size: 11px;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
        }

        .info-value {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 500;
        }

        /* Document Viewer */
        .document-viewer {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .document-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .document-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .document-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .document-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .document-name {
            font-size: 11px;
            color: #6c757d;
            word-break: break-all;
        }

        /* Processing Log */
        .log-timeline {
            position: relative;
            padding-left: 30px;
        }

        .log-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }

        .log-entry {
            position: relative;
            padding: 10px 15px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .log-entry::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 15px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #3498db;
            border: 2px solid white;
        }

        .log-time {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .log-user {
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .log-action {
            font-size: 13px;
            color: #495057;
        }

        /* Processing Actions */
        .processing-section {
            border-top: 2px solid #e9ecef;
            padding-top: 20px;
            margin-top: 20px;
        }

        .processing-note {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
            resize: vertical;
        }

        /* Custom Scrollbar */
        .table-wrapper::-webkit-scrollbar,
        .modal-content::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .table-wrapper::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .table-wrapper::-webkit-scrollbar-thumb,
        .modal-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Actions -->
        <div class="header-actions">
            <h1 class="page-title">üîç Qu·∫£n l√Ω Retro (Y√™u c·∫ßu c·ªông ƒëi·ªÉm b·ªï sung)</h1>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="handleBulkApprove()">
                    ‚úÖ Duy·ªát h√†ng lo·∫°t
                </button>
                <button class="btn btn-secondary" onclick="exportRetros()">
                    üì• Export CSV
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">T·ªïng y√™u c·∫ßu</div>
                <div class="stat-value" id="totalRequests">0</div>
                <div class="stat-subtitle">
                    <span class="stat-trend trend-up">+12%</span>
                    so v·ªõi th√°ng tr∆∞·ªõc
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ch·ªù duy·ªát</div>
                <div class="stat-value" style="color: #f39c12;" id="pendingCount">0</div>
                <div class="stat-subtitle">C·∫ßn x·ª≠ l√Ω ngay</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ƒê√£ duy·ªát</div>
                <div class="stat-value" style="color: #27ae60;" id="approvedCount">0</div>
                <div class="stat-subtitle">T·ª∑ l·ªá duy·ªát: <strong id="approvalRate">0%</strong></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">T·ªïng ƒëi·ªÉm ƒë√£ c·ªông</div>
                <div class="stat-value">2.5M</div>
                <div class="stat-subtitle">Th√°ng n√†y: 450K ƒëi·ªÉm</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-row">
                <div class="filter-group" style="flex: 1;">
                    <label class="filter-label">T√¨m ki·∫øm</label>
                    <input type="text" class="filter-input" id="searchInput" 
                           placeholder="T√™n HV / M√£ HV / Email / SƒêT / M√£ giao d·ªãch..." 
                           onkeyup="filterRetros()">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Ng∆∞·ªùi g·ª≠i</label>
                    <select class="filter-select" id="senderFilter" onchange="filterRetros()">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="H·ªôi vi√™n">H·ªôi vi√™n</option>
                        <option value="Nh√¢n vi√™n CSKH">Nh√¢n vi√™n</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Tr·∫°ng th√°i</label>
                    <select class="filter-select" id="statusFilter" onchange="filterRetros()">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="Ch·ªù duy·ªát">Ch·ªù duy·ªát</option>
                        <option value="ƒê√£ duy·ªát">ƒê√£ duy·ªát</option>
                        <option value="T·ª´ ch·ªëi">T·ª´ ch·ªëi</option>
                        <option value="ƒê√£ x·ª≠ l√Ω">ƒê√£ x·ª≠ l√Ω</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Kho·∫£ng th·ªùi gian</label>
                    <div class="date-range">
                        <input type="date" class="filter-select" id="startDate" onchange="filterRetros()">
                        <span>-</span>
                        <input type="date" class="filter-select" id="endDate" onchange="filterRetros()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Table -->
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">Danh s√°ch y√™u c·∫ßu Retro</h3>
                <div class="table-stats" id="tableStats">Hi·ªÉn th·ªã 0 y√™u c·∫ßu</div>
            </div>
            <div class="table-wrapper">
                <table class="retro-table">
                    <thead>
                        <tr>
                            <th width="30">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th width="100">M√£ y√™u c·∫ßu</th>
                            <th width="150">Th·ªùi gian y√™u c·∫ßu</th>
                            <th width="100">Ng∆∞·ªùi g·ª≠i</th>
                            <th width="200">H·ªôi vi√™n li√™n quan</th>
                            <th width="120">Giao d·ªãch y√™u c·∫ßu</th>
                            <th width="100">Lo·∫°i GD</th>
                            <th width="120">Gi√° tr·ªã GD</th>
                            <th width="120">ƒêi·ªÉm ƒë·ªÅ ngh·ªã</th>
                            <th width="120">ƒêi·ªÉm h·ªá th·ªëng</th>
                            <th width="100">Tr·∫°ng th√°i</th>
                            <th width="80">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="retroTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Chi ti·∫øt y√™u c·∫ßu Retro</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be dynamically loaded -->
            </div>
        </div>
    </div>

    <script>
        // Generate sample data from CSV description
        const retroData = generateRetroData();
        let filteredData = [...retroData];

        function generateRetroData() {
            const data = [];
            const senders = ['H·ªôi vi√™n', 'Nh√¢n vi√™n CSKH'];
            const tiers = ['Member', 'Silver', 'Gold', 'Platinum'];
            const transTypes = ['Tour du l·ªãch', 'V√© m√°y bay', 'Kh√°ch s·∫°n', 'D·ªãch v·ª• kh√°c'];
            const statuses = ['Ch·ªù duy·ªát', 'ƒê√£ duy·ªát', 'T·ª´ ch·ªëi', 'ƒê√£ x·ª≠ l√Ω'];
            const firstNames = ['Nguy·ªÖn', 'Tr·∫ßn', 'L√™', 'Ph·∫°m', 'Ho√†ng', 'V≈©', 'V√µ', 'ƒê·∫∑ng', 'B√πi', 'ƒê·ªó'];
            const middleNames = ['VƒÉn', 'Th·ªã', 'Ho√†ng', 'Minh', 'Thanh', 'Qu·ªëc', 'ƒê·ª©c', 'Th√†nh'];
            const lastNames = ['An', 'B√¨nh', 'C∆∞·ªùng', 'D≈©ng', 'H√≤a', 'Khang', 'Long', 'Minh', 'Nam', 'Ph√∫c'];

            for (let i = 1; i <= 100; i++) {
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const transType = transTypes[Math.floor(Math.random() * transTypes.length)];
                const value = Math.floor(Math.random() * 50000000) + 1000000;
                const suggestedPoints = Math.floor(value / 100000);
                const systemPoints = Math.floor(suggestedPoints * (0.8 + Math.random() * 0.3));
                
                // Generate random date in last 30 days
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                
                const fullName = `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${middleNames[Math.floor(Math.random() * middleNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`;
                
                data.push({
                    'M√£ y√™u c·∫ßu': `RETRO-2025-${String(i).padStart(5, '0')}`,
                    'Ng∆∞·ªùi y√™u c·∫ßu': senders[Math.floor(Math.random() * senders.length)],
                    'Th·ªùi gian t·∫°o': date.toISOString().replace('T', ' ').substr(0, 16),
                    'H·ªç t√™n HV': fullName,
                    'M√£ HV': `HV${String(Math.floor(Math.random() * 99999) + 10000).padStart(5, '0')}`,
                    'H·∫°ng HV': tiers[Math.floor(Math.random() * tiers.length)],
                    'Lo·∫°i giao d·ªãch': transType,
                    'M√£ giao d·ªãch': transType === 'Tour du l·ªãch' ? `T${Math.floor(Math.random() * 99999) + 10000}` :
                                    transType === 'V√© m√°y bay' ? `VN${Math.floor(Math.random() * 999) + 100}` :
                                    transType === 'Kh√°ch s·∫°n' ? `HTL${Math.floor(Math.random() * 9999) + 1000}` :
                                    `SRV${Math.floor(Math.random() * 9999) + 1000}`,
                    'Ng√†y giao d·ªãch': new Date(date.getTime() - Math.floor(Math.random() * 7 * 24 * 60 * 60 * 1000)).toISOString().substr(0, 10),
                    'Gi√° tr·ªã giao d·ªãch': value,
                    'ƒêi·ªÉm ƒë·ªÅ ngh·ªã c·ªông': suggestedPoints,
                    'ƒêi·ªÉm h·ªá th·ªëng t√≠nh': systemPoints,
                    'Tr·∫°ng th√°i': status,
                    'Ghi ch√∫ x·ª≠ l√Ω': status === 'ƒê√£ duy·ªát' ? 'Ch·ª©ng t·ª´ h·ª£p l·ªá, ƒë√£ c·ªông ƒëi·ªÉm' :
                                     status === 'T·ª´ ch·ªëi' ? 'Ch·ª©ng t·ª´ kh√¥ng h·ª£p l·ªá' :
                                     status === 'ƒê√£ x·ª≠ l√Ω' ? 'ƒê√£ x·ª≠ l√Ω v√† c·ªông ƒëi·ªÉm' : ''
                });
            }
            
            // Sort by date descending
            data.sort((a, b) => new Date(b['Th·ªùi gian t·∫°o']) - new Date(a['Th·ªùi gian t·∫°o']));
            
            return data;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadRetros();
            updateStats();
        });

        // Load retros to table
        function loadRetros() {
            const tbody = document.getElementById('retroTableBody');
            tbody.innerHTML = '';

            filteredData.forEach(retro => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="row-select" value="${retro['M√£ y√™u c·∫ßu']}"></td>
                    <td><strong>${retro['M√£ y√™u c·∫ßu']}</strong></td>
                    <td>${formatDateTime(retro['Th·ªùi gian t·∫°o'])}</td>
                    <td>${getSenderBadge(retro['Ng∆∞·ªùi y√™u c·∫ßu'])}</td>
                    <td>
                        <div><strong>${retro['H·ªç t√™n HV']}</strong></div>
                        <div style="font-size: 11px; color: #6c757d;">
                            ${retro['M√£ HV']} - ${getTierBadge(retro['H·∫°ng HV'])}
                        </div>
                    </td>
                    <td><code>${retro['M√£ giao d·ªãch']}</code></td>
                    <td>${getTransTypeBadge(retro['Lo·∫°i giao d·ªãch'])}</td>
                    <td><strong>${formatCurrency(retro['Gi√° tr·ªã giao d·ªãch'])}</strong></td>
                    <td>
                        <span class="points-badge">${retro['ƒêi·ªÉm ƒë·ªÅ ngh·ªã c·ªông'].toLocaleString()}</span>
                    </td>
                    <td>
                        ${retro['ƒêi·ªÉm h·ªá th·ªëng t√≠nh'].toLocaleString()}
                        ${retro['ƒêi·ªÉm ƒë·ªÅ ngh·ªã c·ªông'] !== retro['ƒêi·ªÉm h·ªá th·ªëng t√≠nh'] ? 
                            `<span class="points-diff">(${retro['ƒêi·ªÉm ƒë·ªÅ ngh·ªã c·ªông'] > retro['ƒêi·ªÉm h·ªá th·ªëng t√≠nh'] ? '+' : ''}${retro['ƒêi·ªÉm ƒë·ªÅ ngh·ªã c·ªông'] - retro['ƒêi·ªÉm h·ªá th·ªëng t√≠nh']})</span>` : ''}
                    </td>
                    <td>${getStatusBadge(retro['Tr·∫°ng th√°i'])}</td>
                    <td>
                        <span class="action-icon" onclick="viewDetail('${retro['M√£ y√™u c·∫ßu']}')" title="Xem chi ti·∫øt">üëÅÔ∏è</span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('tableStats').textContent = `Hi·ªÉn th·ªã ${filteredData.length} y√™u c·∫ßu`;
        }

        // Format date time
        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return `<div>${date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</div>
                    <div style="font-size: 11px; color: #6c757d;">${date.toLocaleDateString('vi-VN')}</div>`;
        }

        // Format currency
        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN') + ' ƒë';
        }

        // Get sender badge
        function getSenderBadge(sender) {
            const typeClass = sender === 'H·ªôi vi√™n' ? 'type-member' : 'type-staff';
            return `<span class="type-badge ${typeClass}">${sender}</span>`;
        }

        // Get tier badge
        function getTierBadge(tier) {
            const tierClass = 'tier-' + tier.toLowerCase();
            return `<span class="tier-badge ${tierClass}">${tier}</span>`;
        }

        // Get transaction type badge
        function getTransTypeBadge(type) {
            const typeMap = {
                'Tour du l·ªãch': 'trans-tour',
                'V√© m√°y bay': 'trans-flight',
                'Kh√°ch s·∫°n': 'trans-hotel',
                'D·ªãch v·ª• kh√°c': 'trans-other'
            };
            return `<span class="trans-badge ${typeMap[type] || 'trans-other'}">${type}</span>`;
        }

        // Get status badge
        function getStatusBadge(status) {
            const statusMap = {
                'Ch·ªù duy·ªát': 'status-pending',
                'ƒê√£ duy·ªát': 'status-approved',
                'T·ª´ ch·ªëi': 'status-rejected',
                'ƒê√£ x·ª≠ l√Ω': 'status-processed'
            };
            return `<span class="status-pill ${statusMap[status] || ''}">${status}</span>`;
        }

        // Filter retros
        function filterRetros() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const senderFilter = document.getElementById('senderFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            filteredData = retroData.filter(retro => {
                // Search filter
                if (searchTerm) {
                    const searchFields = [
                        retro['H·ªç t√™n HV'],
                        retro['M√£ HV'],
                        retro['M√£ giao d·ªãch'],
                        retro['M√£ y√™u c·∫ßu']
                    ].join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchTerm)) {
                        return false;
                    }
                }

                // Sender filter
                if (senderFilter && retro['Ng∆∞·ªùi y√™u c·∫ßu'] !== senderFilter) {
                    return false;
                }

                // Status filter
                if (statusFilter && retro['Tr·∫°ng th√°i'] !== statusFilter) {
                    return false;
                }

                // Date range filter
                if (startDate || endDate) {
                    const retroDate = new Date(retro['Th·ªùi gian t·∫°o']);
                    if (startDate && retroDate < new Date(startDate)) return false;
                    if (endDate && retroDate > new Date(endDate + ' 23:59:59')) return false;
                }

                return true;
            });

            loadRetros();
            updateStats();
        }

        // Update statistics
        function updateStats() {
            const total = retroData.length;
            const pending = retroData.filter(r => r['Tr·∫°ng th√°i'] === 'Ch·ªù duy·ªát').length;
            const approved = retroData.filter(r => r['Tr·∫°ng th√°i'] === 'ƒê√£ duy·ªát').length;
            const processed = retroData.filter(r => r['Tr·∫°ng th√°i'] === 'ƒê√£ x·ª≠ l√Ω').length;

            document.getElementById('totalRequests').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedCount').textContent = approved + processed;
            document.getElementById('approvalRate').textContent = 
                Math.round((approved + processed) / total * 100) + '%';
        }

        // View detail
        function viewDetail(requestId) {
            const retro = retroData.find(r => r['M√£ y√™u c·∫ßu'] === requestId);
            if (!retro) return;

            document.getElementById('modalTitle').textContent = `Chi ti·∫øt y√™u c·∫ßu ${requestId}`;
            
            const isPending = retro['Tr·∫°ng th√°i'] === 'Ch·ªù duy·ªát';
            const pointsDiff = retro['ƒêi·ªÉm ƒë·ªÅ ngh·ªã c·ªông'] - retro['ƒêi·ªÉm h·ªá th·ªëng t√≠nh'];

            document.getElementById('modalBody').innerHTML = `
                <!-- Request Info -->
                <div class="info-section">
                    <h3 class="info-section-title">üìã Th√¥ng tin y√™u c·∫ßu</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">M√£ y√™u c·∫ßu</span>
                            <span class="info-value">${retro['M√£ y√™u c·∫ßu']}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ng∆∞·ªùi y√™u c·∫ßu</span>
                            <span class="info-value">${getSenderBadge(retro['Ng∆∞·ªùi y√™u c·∫ßu'])}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Th·ªùi gian t·∫°o</span>
                            <span class="info-value">${new Date(retro['Th·ªùi gian t·∫°o']).toLocaleString('vi-VN')}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tr·∫°ng th√°i</span>
                            <span class="info-value">${getStatusBadge(retro['Tr·∫°ng th√°i'])}</span>
                        </div>
                    </div>
                </div>

                <!-- Member Info -->
                <div class="info-section">
                    <h3 class="info-section-title">üë§ Th√¥ng tin h·ªôi vi√™n</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">H·ªç t√™n</span>
                            <span class="info-value">${retro['H·ªç t√™n HV']}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">M√£ h·ªôi vi√™n</span>
                            <span class="info-value">${retro['M√£ HV']}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">H·∫°ng h·ªôi vi√™n</span>
                            <span class="info-value">${getTierBadge(retro['H·∫°ng HV'])}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email</span>
                            <span class="info-value">${retro['M√£ HV'].toLowerCase()}@email.com</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="alert('Xem l·ªãch s·ª≠ h·ªôi vi√™n ${retro['M√£ HV']}')">
                            üìä Xem l·ªãch s·ª≠ h·ªôi vi√™n
                        </button>
                    </div>
                </div>

                <!-- Transaction Info -->
                <div class="info-section">
                    <h3 class="info-section-title">üí≥ Th√¥ng tin giao d·ªãch</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Lo·∫°i giao d·ªãch</span>
                            <span class="info-value">${getTransTypeBadge(retro['Lo·∫°i giao d·ªãch'])}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">M√£ giao d·ªãch</span>
                            <span class="info-value"><code>${retro['M√£ giao d·ªãch']}</code></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ng√†y giao d·ªãch</span>
                            <span class="info-value">${new Date(retro['Ng√†y giao d·ªãch']).toLocaleDateString('vi-VN')}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Gi√° tr·ªã giao d·ªãch</span>
                            <span class="info-value" style="font-size: 18px; font-weight: bold; color: #2c3e50;">
                                ${formatCurrency(retro['Gi√° tr·ªã giao d·ªãch'])}
                            </span>
                        </div>
                    </div>
                    <div class="info-grid" style="margin-top: 15px; background: white; padding: 15px; border-radius: 8px;">
                        <div class="info-item">
                            <span class="info-label">ƒêi·ªÉm ƒë·ªÅ ngh·ªã c·ªông</span>
                            <span class="info-value">
                                <span class="points-badge" style="font-size: 16px;">
                                    ${retro['ƒêi·ªÉm ƒë·ªÅ ngh·ªã c·ªông'].toLocaleString()} ƒëi·ªÉm
                                </span>
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ƒêi·ªÉm h·ªá th·ªëng t√≠nh</span>
                            <span class="info-value" style="font-size: 16px;">
                                ${retro['ƒêi·ªÉm h·ªá th·ªëng t√≠nh'].toLocaleString()} ƒëi·ªÉm
                                ${pointsDiff !== 0 ? 
                                    `<span class="points-diff">(Ch√™nh l·ªách: ${pointsDiff > 0 ? '+' : ''}${pointsDiff})</span>` : ''}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Documents -->
                <div class="info-section">
                    <h3 class="info-section-title">üìé Ch·ª©ng t·ª´ ƒë√≠nh k√®m</h3>
                    <div class="document-grid">
                        <div class="document-item" onclick="alert('Xem h√≥a ƒë∆°n')">
                            <div class="document-icon">üìÑ</div>
                            <div class="document-name">hoadon_${retro['M√£ giao d·ªãch']}.pdf</div>
                        </div>
                        ${retro['Lo·∫°i giao d·ªãch'] === 'V√© m√°y bay' ? `
                            <div class="document-item" onclick="alert('Xem boarding pass')">
                                <div class="document-icon">‚úàÔ∏è</div>
                                <div class="document-name">boarding_pass.jpg</div>
                            </div>
                        ` : ''}
                        <div class="document-item" onclick="alert('Xem bi√™n lai')">
                            <div class="document-icon">üßæ</div>
                            <div class="document-name">bienlai_thanhtoan.jpg</div>
                        </div>
                    </div>
                </div>

                <!-- Processing Log -->
                <div class="info-section">
                    <h3 class="info-section-title">üìù Nh·∫≠t k√Ω x·ª≠ l√Ω</h3>
                    <div class="log-timeline">
                        ${generateProcessingLog(retro)}
                    </div>
                </div>

                <!-- Processing Actions (only for pending) -->
                ${isPending ? `
                    <div class="processing-section">
                        <h3 class="info-section-title">‚öôÔ∏è X·ª≠ l√Ω y√™u c·∫ßu</h3>
                        <div>
                            <label style="font-size: 13px; color: #6c757d; font-weight: 600;">Ghi ch√∫ x·ª≠ l√Ω:</label>
                            <textarea class="processing-note" id="processingNote" 
                                      placeholder="Nh·∫≠p ghi ch√∫ x·ª≠ l√Ω..."></textarea>
                        </div>
                        <div class="action-buttons" style="justify-content: space-between;">
                            <button class="btn btn-secondary" onclick="requestMoreDocs()">
                                üìã Y√™u c·∫ßu b·ªï sung
                            </button>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-danger" onclick="rejectRequest('${requestId}')">
                                    ‚ùå T·ª´ ch·ªëi
                                </button>
                                <button class="btn btn-success" onclick="approveRequest('${requestId}')">
                                    ‚úÖ Duy·ªát y√™u c·∫ßu
                                </button>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;

            document.getElementById('detailModal').classList.add('active');
        }

        // Generate processing log
        function generateProcessingLog(retro) {
            let log = `
                <div class="log-entry">
                    <div class="log-time">${new Date(retro['Th·ªùi gian t·∫°o']).toLocaleString('vi-VN')}</div>
                    <div class="log-user">${retro['Ng∆∞·ªùi y√™u c·∫ßu']}</div>
                    <div class="log-action">T·∫°o y√™u c·∫ßu retro</div>
                </div>
            `;

            if (retro['Tr·∫°ng th√°i'] !== 'Ch·ªù duy·ªát') {
                const processDate = new Date(retro['Th·ªùi gian t·∫°o']);
                processDate.setHours(processDate.getHours() + Math.floor(Math.random() * 48) + 1);
                
                log += `
                    <div class="log-entry">
                        <div class="log-time">${processDate.toLocaleString('vi-VN')}</div>
                        <div class="log-user">Admin CSKH</div>
                        <div class="log-action">
                            ${retro['Tr·∫°ng th√°i'] === 'ƒê√£ duy·ªát' ? 'ƒê√£ duy·ªát v√† c·ªông ƒëi·ªÉm' :
                              retro['Tr·∫°ng th√°i'] === 'T·ª´ ch·ªëi' ? 'ƒê√£ t·ª´ ch·ªëi y√™u c·∫ßu' :
                              'ƒê√£ x·ª≠ l√Ω y√™u c·∫ßu'}
                            ${retro['Ghi ch√∫ x·ª≠ l√Ω'] ? `<div style="margin-top: 5px; font-size: 12px; color: #6c757d;">"${retro['Ghi ch√∫ x·ª≠ l√Ω']}"</div>` : ''}
                        </div>
                    </div>
                `;
            }

            return log;
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // Approve request
        function approveRequest(requestId) {
            const note = document.getElementById('processingNote').value;
            if (!note) {
                alert('Vui l√≤ng nh·∫≠p ghi ch√∫ x·ª≠ l√Ω!');
                return;
            }

            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën duy·ªát y√™u c·∫ßu n√†y?')) {
                const retro = retroData.find(r => r['M√£ y√™u c·∫ßu'] === requestId);
                if (retro) {
                    retro['Tr·∫°ng th√°i'] = 'ƒê√£ duy·ªát';
                    retro['Ghi ch√∫ x·ª≠ l√Ω'] = note;
                    alert(`ƒê√£ duy·ªát y√™u c·∫ßu ${requestId} v√† c·ªông ${retro['ƒêi·ªÉm h·ªá th·ªëng t√≠nh'].toLocaleString()} ƒëi·ªÉm cho h·ªôi vi√™n ${retro['M√£ HV']}`);
                    closeModal();
                    filterRetros();
                }
            }
        }

        // Reject request
        function rejectRequest(requestId) {
            const note = document.getElementById('processingNote').value;
            if (!note) {
                alert('Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi!');
                return;
            }

            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën t·ª´ ch·ªëi y√™u c·∫ßu n√†y?')) {
                const retro = retroData.find(r => r['M√£ y√™u c·∫ßu'] === requestId);
                if (retro) {
                    retro['Tr·∫°ng th√°i'] = 'T·ª´ ch·ªëi';
                    retro['Ghi ch√∫ x·ª≠ l√Ω'] = note;
                    alert(`ƒê√£ t·ª´ ch·ªëi y√™u c·∫ßu ${requestId}`);
                    closeModal();
                    filterRetros();
                }
            }
        }

        // Request more documents
        function requestMoreDocs() {
            const note = document.getElementById('processingNote').value;
            if (!note) {
                alert('Vui l√≤ng nh·∫≠p y√™u c·∫ßu b·ªï sung!');
                return;
            }
            alert('ƒê√£ g·ª≠i y√™u c·∫ßu b·ªï sung ch·ª©ng t·ª´ ƒë·∫øn h·ªôi vi√™n');
        }

        // Toggle select all
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            document.querySelectorAll('.row-select').forEach(cb => {
                cb.checked = selectAll;
            });
        }

        // Handle bulk approve
        function handleBulkApprove() {
            const selected = document.querySelectorAll('.row-select:checked');
            if (selected.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt y√™u c·∫ßu!');
                return;
            }

            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën duy·ªát ${selected.length} y√™u c·∫ßu ƒë√£ ch·ªçn?`)) {
                let approvedCount = 0;
                selected.forEach(cb => {
                    const requestId = cb.value;
                    const retro = retroData.find(r => r['M√£ y√™u c·∫ßu'] === requestId);
                    if (retro && retro['Tr·∫°ng th√°i'] === 'Ch·ªù duy·ªát') {
                        retro['Tr·∫°ng th√°i'] = 'ƒê√£ duy·ªát';
                        retro['Ghi ch√∫ x·ª≠ l√Ω'] = 'Duy·ªát h√†ng lo·∫°t';
                        approvedCount++;
                    }
                });
                alert(`ƒê√£ duy·ªát th√†nh c√¥ng ${approvedCount} y√™u c·∫ßu!`);
                filterRetros();
            }
        }

        // Export retros
        function exportRetros() {
            alert('Xu·∫•t file CSV danh s√°ch y√™u c·∫ßu retro');
        }
    </script>
</body>
</html>