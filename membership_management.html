<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý hội viên - Vietravel Loyalty</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            overflow-x: hidden;
        }

        .container {
            padding: 20px;
            max-width: 1405px;
            margin: 0 auto;
        }

        /* Search & Filter Bar */
        .search-filter-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .search-section {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .search-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .create-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .create-btn:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }

        /* Main Content Layout */
        .main-layout {
            display: flex;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .members-table-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .table-stats {
            font-size: 14px;
            color: #6c757d;
        }

        .table-wrapper {
            flex: 1;
            overflow: auto;
        }

        .members-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .members-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .members-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }

        .members-table tbody tr {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .members-table tbody tr:hover {
            background: #f8f9fa;
        }

        .members-table tbody tr.selected {
            background: #e3f2fd;
            border-left: 4px solid #3498db;
        }

        /* Status Pills */
        .status-pill {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #fff3cd; color: #856404; }
        .status-suspend { background: #f8d7da; color: #721c24; }
        .status-closed { background: #d1ecf1; color: #0c5460; }

        /* Tier Pills */
        .tier-pill {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .tier-vietravel { background: #e2e3e5; color: #495057; }
        .tier-silver { background: #d1ecf1; color: #0c5460; }
        .tier-gold { background: #fff3cd; color: #856404; }
        .tier-platinum { background: #d4edda; color: #155724; }

        /* Progress Bars */
        .progress-container {
            width: 60px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #3498db;
            transition: width 0.3s ease;
        }

        /* Flags */
        .flags-container {
            display: flex;
            gap: 4px;
        }

        .flag {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .flag-suspicious { background: #dc3545; color: white; }
        .flag-family { background: #17a2b8; color: white; }
        .flag-mgm { background: #28a745; color: white; }

        /* Detail Panel */
        .detail-panel {
            width: 650px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            flex-direction: column;
            max-height: 100%;
            position: relative;
        }

        .detail-panel.active {
            display: flex;
        }

        .detail-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .detail-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            flex: 1;
        }

        .close-detail {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6c757d;
            padding: 5px;
        }

        .detail-tabs {
            display: flex;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .detail-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background: none;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .detail-tab.active {
            background: white;
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }

        .detail-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .field-group {
            margin-bottom: 20px;
        }

        .field-label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }

        .field-value {
            font-size: 14px;
            color: #2c3e50;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .field-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .btn-success {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
            border-color: #ffc107;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .modal-body {
            padding: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        /* Validation */
        .validation-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }

        .field-input.error {
            border-color: #dc3545;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .main-layout {
                flex-direction: column;
            }
            
            .detail-panel {
                width: 100%;
                max-height: 500px;
            }
        }

        @media (max-width: 1200px) {
            .detail-panel {
                width: 100%;
                max-height: 400px;
            }
        }

        /* Custom Scrollbar */
        .table-wrapper::-webkit-scrollbar, .detail-content::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .table-wrapper::-webkit-scrollbar-track, .detail-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .table-wrapper::-webkit-scrollbar-thumb, .detail-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover, .detail-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Search & Filter Bar -->
        <div class="search-filter-bar">
            <div class="search-section">
                <input type="text" class="search-input" id="searchInput" placeholder="Tìm kiếm theo SĐT, Mã HV, Họ tên...">
                <button class="search-btn" onclick="searchMembers()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                    Tìm kiếm
                </button>
                <button class="create-btn" onclick="openCreateModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Tạo mới
                </button>
            </div>

    <!-- Reward Points Detail Modal -->
    <div class="modal" id="rewardPointsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Chi tiết điểm thưởng</h3>
                <button class="close-detail" onclick="closeRewardPointsModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="field-group">
                    <label class="field-label">Tổng điểm thưởng khả dụng</label>
                    <div class="field-value" id="totalRewardPoints" style="font-size: 18px; font-weight: bold; color: #27ae60;"></div>
                </div>
                
                <div class="field-group">
                    <label class="field-label">Chi tiết theo kỳ hết hạn</label>
                    <div style="border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                            <thead style="background: #f8f9fa;">
                                <tr>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6;">Ngày tích điểm</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6;">Điểm</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6;">Ngày hết hạn</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6;">Còn lại (ngày)</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6;">Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody id="rewardPointsDetailTable">
                                <!-- Content will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="field-group">
                    <label class="field-label">Thống kê theo thời gian hết hạn</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: bold; color: #856404;" id="expiring30Days">0</div>
                            <div style="font-size: 12px; color: #856404;">Hết hạn trong 30 ngày</div>
                        </div>
                        <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: bold; color: #0c5460;" id="expiring90Days">0</div>
                            <div style="font-size: 12px; color: #0c5460;">Hết hạn trong 90 ngày</div>
                        </div>
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: bold; color: #155724;" id="validLongTerm">0</div>
                            <div style="font-size: 12px; color: #155724;">Còn hiệu lực lâu dài</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="closeRewardPointsModal()">Đóng</button>
                    <button class="btn btn-warning" onclick="exportPointsDetail()">Xuất Excel</button>
                </div>
            </div>
        </div>
    </div>
            
            <div class="filter-section">
                <div class="filter-group">
                    <label class="filter-label">Trạng thái</label>
                    <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                        <option value="">Tất cả</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Suspend">Suspend</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Loại HV</label>
                    <select class="filter-select" id="typeFilter" onchange="applyFilters()">
                        <option value="">Tất cả</option>
                        <option value="ADL">ADL (≥15 tuổi)</option>
                        <option value="CHD">CHD (<15 tuổi)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Hạng thẻ</label>
                    <select class="filter-select" id="tierFilter" onchange="applyFilters()">
                        <option value="">Tất cả</option>
                        <option value="Vietravel">Vietravel</option>
                        <option value="Bạc">Bạc</option>
                        <option value="Vàng">Vàng</option>
                        <option value="Bạch kim">Bạch kim</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Nguồn tạo</label>
                    <select class="filter-select" id="sourceFilter" onchange="applyFilters()">
                        <option value="">Tất cả</option>
                        <option value="Nhân viên">Nhân viên</option>
                        <option value="Tự động">Tự động sau tour</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Cờ đặc biệt</label>
                    <select class="filter-select" id="flagFilter" onchange="applyFilters()">
                        <option value="">Tất cả</option>
                        <option value="suspicious">Nghi vấn</option>
                        <option value="family">Family Plan</option>
                        <option value="mgm">MgM</option>
                        <option value="inactive">Inactivity ≥24M</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Members Table -->
            <div class="members-table-container">
                <div class="table-header">
                    <h3 class="table-title">Danh sách hội viên</h3>
                    <div class="table-stats" id="tableStats">Hiển thị 0 - 0 của 0 hội viên</div>
                </div>
                
                <div class="table-wrapper">
                    <table class="members-table" id="membersTable">
                        <thead>
                            <tr>
                                <th>Mã HV</th>
                                <th>Họ tên</th>
                                <th>Tuổi/Loại</th>
                                <th>SĐT/Email</th>
                                <th>Trạng thái</th>
                                <th>Hạng/Tiến độ</th>
                                <th>Điểm Vàng (12M)</th>
                                <th>Điểm Thưởng</th>
                                <th>GD gần nhất</th>
                                <th>Cờ</th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Detail Panel -->
            <div class="detail-panel" id="detailPanel">
                <div class="detail-header">
                    <h3 class="detail-title" id="detailTitle">Chi tiết hội viên</h3>
                    <button class="close-detail" onclick="closeDetailPanel()">×</button>
                </div>
                
                <div class="detail-tabs">
                    <button class="detail-tab active" onclick="switchTab('profile')">Hồ sơ</button>
                    <button class="detail-tab" onclick="switchTab('points')">Điểm & Hạng</button>
                    <button class="detail-tab" onclick="switchTab('transactions')">GD & Retro</button>
                    <button class="detail-tab" onclick="switchTab('family')">Family</button>
                    <button class="detail-tab" onclick="switchTab('rewards')">Trả thưởng</button>
                    <button class="detail-tab" onclick="switchTab('security')">Bảo mật</button>
                </div>
                
                <div class="detail-content" id="detailContent">
                    <!-- Content will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create Member Modal -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Tạo hội viên mới</h3>
                <button class="close-detail" onclick="closeCreateModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="createMemberForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="field-label">Họ và tên *</label>
                            <input type="text" class="field-input" id="fullName" required>
                            <div class="validation-error" id="fullNameError"></div>
                        </div>
                        <div class="form-group">
                            <label class="field-label">Giới tính</label>
                            <select class="field-input" id="gender">
                                <option value="Nam">Nam</option>
                                <option value="Nữ">Nữ</option>
                                <option value="Khác">Khác</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="field-label">Ngày sinh *</label>
                            <input type="date" class="field-input" id="dob" required onchange="checkAge()">
                            <div class="validation-error" id="dobError"></div>
                        </div>
                        <div class="form-group">
                            <label class="field-label">Số điện thoại</label>
                            <input type="tel" class="field-input" id="phone" onblur="validatePhone()">
                            <div class="validation-error" id="phoneError"></div>
                            <div id="phoneNote" style="font-size: 11px; color: #6c757d; margin-top: 2px;">
                                Bắt buộc cho ADL (≥15 tuổi). SĐT phải duy nhất.
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="field-label">Email</label>
                        <input type="email" class="field-input" id="email">
                        <div style="font-size: 11px; color: #28a745; margin-top: 2px;">
                            Không bắt buộc nhưng được cộng 10 điểm thưởng khi cung cấp
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="field-label">Địa chỉ *</label>
                        <textarea class="field-input" id="address" rows="2" required></textarea>
                        <div class="validation-error" id="addressError"></div>
                    </div>
                    
                    <div class="form-group full-width" id="guardianSection" style="display: none;">
                        <label class="field-label">Mã tài khoản người bảo hộ *</label>
                        <input type="text" class="field-input" id="guardianCode" onblur="validateGuardian()">
                        <div class="validation-error" id="guardianError"></div>
                        <div style="font-size: 11px; color: #dc3545; margin-top: 2px;">
                            Bắt buộc cho CHD (<15 tuổi). Tài khoản guardian phải có email.
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Hủy</button>
                        <button type="submit" class="btn btn-success">Tạo tài khoản</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reward Points Detail Modal -->
    <div class="modal" id="rewardPointsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Chi tiết điểm thưởng</h3>
                <button class="close-detail" onclick="closeRewardPointsModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="field-group">
                    <label class="field-label">Tổng điểm thưởng khả dụng</label>
                    <div class="field-value" id="totalRewardPoints" style="font-size: 18px; font-weight: bold; color: #27ae60;"></div>
                </div>
                
                <div class="field-group">
                    <label class="field-label">Chi tiết theo kỳ hết hạn</label>
                    <div style="border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                            <thead style="background: #f8f9fa;">
                                <tr>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6;">Ngày tích điểm</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6;">Điểm</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6;">Ngày hết hạn</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6;">Còn lại (ngày)</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid #dee2e6;">Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody id="rewardPointsDetailTable">
                                <!-- Content will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="field-group">
                    <label class="field-label">Thống kê theo thời gian hết hạn</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: bold; color: #856404;" id="expiring30Days">0</div>
                            <div style="font-size: 12px; color: #856404;">Hết hạn trong 30 ngày</div>
                        </div>
                        <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: bold; color: #0c5460;" id="expiring90Days">0</div>
                            <div style="font-size: 12px; color: #0c5460;">Hết hạn trong 90 ngày</div>
                        </div>
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: bold; color: #155724;" id="validLongTerm">0</div>
                            <div style="font-size: 12px; color: #155724;">Còn hiệu lực lâu dài</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="closeRewardPointsModal()">Đóng</button>
                    <button class="btn btn-warning" onclick="exportPointsDetail()">Xuất Excel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mock data from CSV files (20 rows each)
        const membersData = [
            { member_code: '929100101001', full_name: 'Nguyễn Văn An', gender: 'Nam', dob: '1985-05-15', age: 39, type: 'ADL', phone: '0901234567', email: 'nva@gmail.com', address: 'Hà Nội', status: 'Active', tier: 'Vàng', start_active_date: '2023-01-15', source: 'Nhân viên', guardian_member_code: '', points_gold_12m: 850, points_reward_available: 2450, reward_expiry_nearest: '2024-12-31', points_to_next_tier: 650, tours_12m: 3, rank_progress_pct: 56.7, last_txn_date: '2024-10-15', last_txn_type: 'Tour', family_group_id: 'FAM001', flag_suspicious: false, flag_family_plan: true, flag_mgm: false, inviter_phone: null, inactivity_months: 0 },
            { member_code: '929100101002', full_name: 'Trần Thị Bình', gender: 'Nữ', dob: '1990-08-22', age: 34, type: 'ADL', phone: '0912345678', email: 'ttb@gmail.com', address: 'TP.HCM', status: 'Active', tier: 'Bạc', start_active_date: '2023-03-20', source: 'Tự động', guardian_member_code: '', points_gold_12m: 320, points_reward_available: 890, reward_expiry_nearest: '2025-02-28', points_to_next_tier: 380, tours_12m: 2, rank_progress_pct: 45.7, last_txn_date: '2024-09-28', last_txn_type: 'Vé MB', family_group_id: '', flag_suspicious: false, flag_family_plan: false, flag_mgm: true, inviter_phone: '0901234567', inactivity_months: 0 },
            { member_code: '929100101003', full_name: 'Lê Minh Công', gender: 'Nam', dob: '1978-12-10', age: 46, type: 'ADL', phone: '0923456789', email: '', address: 'Đà Nẵng', status: 'Suspend', tier: 'Bạch kim', start_active_date: '2022-06-10', source: 'Nhân viên', guardian_member_code: '', points_gold_12m: 2100, points_reward_available: 5670, reward_expiry_nearest: '2024-11-15', points_to_next_tier: 0, tours_12m: 8, rank_progress_pct: 100.0, last_txn_date: '2024-08-10', last_txn_type: 'Tour', family_group_id: '', flag_suspicious: true, flag_family_plan: false, flag_mgm: false, inviter_phone: null, inactivity_months: 2 },
            { member_code: '929100101004', full_name: 'Phạm Thị Dung', gender: 'Nữ', dob: '1995-03-05', age: 29, type: 'ADL', phone: '0934567890', email: 'ptd@yahoo.com', address: 'Hải Phòng', status: 'Active', tier: 'Vietravel', start_active_date: '2024-01-12', source: 'Tự động', guardian_member_code: '', points_gold_12m: 85, points_reward_available: 125, reward_expiry_nearest: '2025-06-30', points_to_next_tier: 115, tours_12m: 1, rank_progress_pct: 42.5, last_txn_date: '2024-10-20', last_txn_type: 'Đổi ngoại tệ', family_group_id: '', flag_suspicious: false, flag_family_plan: false, flag_mgm: false, inviter_phone: null, inactivity_months: 0 },
            { member_code: '929100101005', full_name: 'Hoàng Văn Em', gender: 'Nam', dob: '2012-07-18', age: 12, type: 'CHD', phone: '', email: '', address: 'Cần Thơ', status: 'Active', tier: 'Vietravel', start_active_date: '2024-02-28', source: 'Nhân viên', guardian_member_code: '929100101001', points_gold_12m: 45, points_reward_available: 78, reward_expiry_nearest: '2025-08-31', points_to_next_tier: 155, tours_12m: 1, rank_progress_pct: 22.5, last_txn_date: '2024-09-15', last_txn_type: 'Tour', family_group_id: 'FAM001', flag_suspicious: false, flag_family_plan: true, flag_mgm: false, inviter_phone: null, inactivity_months: 0 },
            { member_code: '929100101006', full_name: 'Vũ Thị Giang', gender: 'Nữ', dob: '1988-11-30', age: 36, type: 'ADL', phone: '0945678901', email: 'vtg@outlook.com', address: 'Nha Trang', status: 'Inactive', tier: 'Bạc', start_active_date: '2022-09-15', source: 'Tự động', guardian_member_code: '', points_gold_12m: 180, points_reward_available: 340, reward_expiry_nearest: '2024-12-15', points_to_next_tier: 520, tours_12m: 1, rank_progress_pct: 25.7, last_txn_date: '2023-05-20', last_txn_type: 'Tour', family_group_id: '', flag_suspicious: false, flag_family_plan: false, flag_mgm: false, inviter_phone: null, inactivity_months: 17 },
            { member_code: '929100101007', full_name: 'Đinh Minh Hiệp', gender: 'Nam', dob: '1982-04-25', age: 42, type: 'ADL', phone: '0956789012', email: 'dmh@gmail.com', address: 'Huế', status: 'Active', tier: 'Vàng', start_active_date: '2023-05-08', source: 'Nhân viên', guardian_member_code: '', points_gold_12m: 1200, points_reward_available: 3200, reward_expiry_nearest: '2025-01-20', points_to_next_tier: 300, tours_12m: 5, rank_progress_pct: 80.0, last_txn_date: '2024-10-22', last_txn_type: 'Thuê xe', family_group_id: '', flag_suspicious: false, flag_family_plan: false, flag_mgm: true, inviter_phone: '0923456789', inactivity_months: 0 },
            { member_code: '929100101008', full_name: 'Bùi Thị Lan', gender: 'Nữ', dob: '1993-09-12', age: 31, type: 'ADL', phone: '0967890123', email: '', address: 'Vũng Tàu', status: 'Active', tier: 'Bạc', start_active_date: '2023-08-03', source: 'Tự động', guardian_member_code: '', points_gold_12m: 450, points_reward_available: 890, reward_expiry_nearest: '2025-03-15', points_to_next_tier: 250, tours_12m: 2, rank_progress_pct: 64.3, last_txn_date: '2024-10-18', last_txn_type: 'Vé MB', family_group_id: '', flag_suspicious: false, flag_family_plan: false, flag_mgm: false, inviter_phone: null, inactivity_months: 0 },
            { member_code: '929100101009', full_name: 'Ngô Văn Minh', gender: 'Nam', dob: '1976-01-20', age: 48, type: 'ADL', phone: '0978901234', email: 'nvm@hotmail.com', address: 'Đà Lạt', status: 'Closed', tier: 'Vietravel', start_active_date: '2021-11-25', source: 'Nhân viên', guardian_member_code: '', points_gold_12m: 0, points_reward_available: 0, reward_expiry_nearest: '', points_to_next_tier: 200, tours_12m: 0, rank_progress_pct: 0.0, last_txn_date: '2022-12-08', last_txn_type: 'Tour', family_group_id: '', flag_suspicious: false, flag_family_plan: false, flag_mgm: false, inviter_phone: null, inactivity_months: 32 },
            { member_code: '929100101010', full_name: 'Cao Thị Nga', gender: 'Nữ', dob: '1987-06-14', age: 37, type: 'ADL', phone: '0989012345', email: 'ctn@gmail.com', address: 'Quy Nhơn', status: 'Active', tier: 'Bạch kim', start_active_date: '2022-12-18', source: 'Tự động', guardian_member_code: '', points_gold_12m: 1850, points_reward_available: 4200, reward_expiry_nearest: '2025-05-10', points_to_next_tier: 0, tours_12m: 6, rank_progress_pct: 100.0, last_txn_date: '2024-10-25', last_txn_type: 'Du học', family_group_id: '', flag_suspicious: false, flag_family_plan: false, flag_mgm: false, inviter_phone: null, inactivity_months: 0 },
            { member_code: '929100101011', full_name: 'Đặng Văn Phong', gender: 'Nam', dob: '1991-10-07', age: 33, type: 'ADL', phone: '0990123456', email: 'dvp@yahoo.com', address: 'Bình Dương', status: 'Suspend', tier: 'Bạc', start_active_date: '2023-04-22', source: 'Nhân viên', guardian_member_code: '', points_gold_12m: 280, points_reward_available: 520, reward_expiry_nearest: '2024-11-30', points_to_next_tier: 420, tours_12m: 1, rank_progress_pct: 40.0, last_txn_date: '2024-07-12', last_txn_type: 'Tour', family_group_id: '', flag_suspicious: true, flag_family_plan: false, flag_mgm: false, inviter_phone: null, inactivity_months: 3 },
            { member_code: '929100101012', full_name: 'Lý Thị Quỳnh', gender: 'Nữ', dob: '1996-12-03', age: 28, type: 'ADL', phone: '0901234568', email: 'ltq@gmail.com', address: 'Long An', status: 'Active', tier: 'Vàng', start_active_date: '2023-07-16', source: 'Tự động', guardian_member_code: '', points_gold_12m: 950, points_reward_available: 2100, reward_expiry_nearest: '2025-04-25', points_to_next_tier: 550, tours_12m: 4, rank_progress_pct: 63.3, last_txn_date: '2024-10-21', last_txn_type: 'Đổi ngoại tệ', family_group_id: 'FAM002', flag_suspicious: false, flag_family_plan: true, flag_mgm: true, inviter_phone: '0934567890', inactivity_months: 0 },
            { member_code: '929100101013', full_name: 'Trương Minh Sơn', gender: 'Nam', dob: '2010-02-28', age: 14, type: 'CHD', phone: '', email: '', address: 'Tiền Giang', status: 'Active', tier: 'Vietravel', start_active_date: '2024-03-10', source: 'Nhân viên', guardian_member_code: '929100101012', points_gold_12m: 35, points_reward_available: 65, reward_expiry_nearest: '2025-09-15', points_to_next_tier: 165, tours_12m: 1, rank_progress_pct: 17.5, last_txn_date: '2024-08-22', last_txn_type: 'Tour', family_group_id: 'FAM002', flag_suspicious: false, flag_family_plan: true, flag_mgm: false, inviter_phone: null, inactivity_months: 0 },
            { member_code: '929100101014', full_name: 'Phan Thị Thu', gender: 'Nữ', dob: '1989-05-18', age: 35, type: 'ADL', phone: '0912345679', email: 'ptt@outlook.com', address: 'Bến Tre', status: 'Active', tier: 'Bạc', start_active_date: '2023-10-05', source: 'Tự động', guardian_member_code: '', points_gold_12m: 380, points_reward_available: 750, reward_expiry_nearest: '2025-02-10', points_to_next_tier: 320, tours_12m: 2, rank_progress_pct: 54.3, last_txn_date: '2024-10-19', last_txn_type: 'Vé MB', family_group_id: '', flag_suspicious: false, flag_family_plan: false, flag_mgm: false, inviter_phone: null, inactivity_months: 0 },
            { member_code: '929100101015', full_name: 'Võ Văn Uy', gender: 'Nam', dob: '1983-08-09', age: 41, type: 'ADL', phone: '0923456790', email: 'vvu@gmail.com', address: 'An Giang', status: 'Inactive', tier: 'Vàng', start_active_date: '2022-05-28', source: 'Nhân viên', guardian_member_code: '', points_gold_12m: 720, points_reward_available: 1200, reward_expiry_nearest: '2024-10-30', points_to_next_tier: 780, tours_12m: 3, rank_progress_pct: 48.0, last_txn_date: '2023-03-15', last_txn_type: 'Tour', family_group_id: '', flag_suspicious: false, flag_family_plan: false, flag_mgm: false, inviter_phone: null, inactivity_months: 20 },
            { member_code: '929100101016', full_name: 'Hoàng Thị Vân', gender: 'Nữ', dob: '1994-11-26', age: 30, type: 'ADL', phone: '0934567891', email: '', address: 'Sóc Trăng', status: 'Active', tier: 'Vietravel', start_active_date: '2024-06-18', source: 'Tự động', guardian_member_code: '', points_gold_12m: 125, points_reward_available: 180, reward_expiry_nearest: '2025-08-20', points_to_next_tier: 75, tours_12m: 1, rank_progress_pct: 62.5, last_txn_date: '2024-10-16', last_txn_type: 'Thuê xe', family_group_id: '', flag_suspicious: false, flag_family_plan: false, flag_mgm: true, inviter_phone: '0945678901', inactivity_months: 0 },
            { member_code: '929100101017', full_name: 'Dương Minh Xuân', gender: 'Nam', dob: '1980-01-12', age: 44, type: 'ADL', phone: '0945678902', email: 'dmx@hotmail.com', address: 'Cà Mau', status: 'Active', tier: 'Bạch kim', start_active_date: '2022-08-08', source: 'Nhân viên', guardian_member_code: '', points_gold_12m: 2300, points_reward_available: 6800, reward_expiry_nearest: '2025-01-05', points_to_next_tier: 0, tours_12m: 9, rank_progress_pct: 100.0, last_txn_date: '2024-10-24', last_txn_type: 'Du học', family_group_id: '', flag_suspicious: false, flag_family_plan: false, flag_mgm: false, inviter_phone: null, inactivity_months: 0 },
            { member_code: '929100101018', full_name: 'Lê Thị Yến', gender: 'Nữ', dob: '1992-03-04', age: 32, type: 'ADL', phone: '0956789013', email: 'lty@gmail.com', address: 'Kiên Giang', status: 'Active', tier: 'Bạc', start_active_date: '2023-11-12', source: 'Tự động', guardian_member_code: '', points_gold_12m: 420, points_reward_available: 980, reward_expiry_nearest: '2025-06-18', points_to_next_tier: 280, tours_12m: 2, rank_progress_pct: 60.0, last_txn_date: '2024-10-17', last_txn_type: 'Vé MB', family_group_id: '', flag_suspicious: false, flag_family_plan: false, flag_mgm: false, inviter_phone: null, inactivity_months: 0 },
            { member_code: '929100101019', full_name: 'Nguyễn Văn Zung', gender: 'Nam', dob: '1986-07-21', age: 38, type: 'ADL', phone: '0967890124', email: 'nvz@yahoo.com', address: 'Bạc Liêu', status: 'Suspend', tier: 'Vàng', start_active_date: '2023-02-14', source: 'Nhân viên', guardian_member_code: '', points_gold_12m: 680, points_reward_available: 1450, reward_expiry_nearest: '2024-12-20', points_to_next_tier: 820, tours_12m: 3, rank_progress_pct: 45.3, last_txn_date: '2024-06-30', last_txn_type: 'Tour', family_group_id: '', flag_suspicious: true, flag_family_plan: false, flag_mgm: false, inviter_phone: null, inactivity_months: 4 },
            { member_code: '929100101020', full_name: 'Trần Thị Ánh', gender: 'Nữ', dob: '1997-09-16', age: 27, type: 'ADL', phone: '0978901235', email: 'tta@gmail.com', address: 'Hậu Giang', status: 'Active', tier: 'Vietravel', start_active_date: '2024-04-25', source: 'Tự động', guardian_member_code: '', points_gold_12m: 95, points_reward_available: 140, reward_expiry_nearest: '2025-07-12', points_to_next_tier: 105, tours_12m: 1, rank_progress_pct: 47.5, last_txn_date: '2024-10-23', last_txn_type: 'Đổi ngoại tệ', family_group_id: '', flag_suspicious: false, flag_family_plan: false, flag_mgm: true, inviter_phone: '0989012345', inactivity_months: 0 }
        ];

        let currentMember = null;
        let filteredMembers = [...membersData];
        let currentTab = 'profile';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadMembers();
            updateTableStats();
        });

        // Load members into table
        function loadMembers() {
            const tbody = document.getElementById('membersTableBody');
            tbody.innerHTML = '';

            filteredMembers.forEach(member => {
                const row = createMemberRow(member);
                tbody.appendChild(row);
            });

            updateTableStats();
        }

        // Create member table row
        function createMemberRow(member) {
            const row = document.createElement('tr');
            row.onclick = () => selectMember(member);

            row.innerHTML = `
                <td><strong>${member.member_code}</strong></td>
                <td>${member.full_name}</td>
                <td>
                    ${member.age} tuổi<br>
                    <span class="tier-pill tier-${member.type.toLowerCase()}">${member.type}</span>
                </td>
                <td>
                    ${member.phone ? formatPhone(member.phone) : 'N/A'}<br>
                    <small style="color: #6c757d;">${member.email || 'Chưa có email'}</small>
                </td>
                <td><span class="status-pill status-${member.status.toLowerCase()}">${member.status}</span></td>
                <td>
                    <span class="tier-pill tier-${getTierClass(member.tier)}">${member.tier}</span><br>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${member.rank_progress_pct}%"></div>
                    </div>
                    <small>${member.rank_progress_pct}%</small>
                </td>
                <td><strong>${member.points_gold_12m.toLocaleString()}</strong></td>
                <td>
                    <strong>${member.points_reward_available.toLocaleString()}</strong><br>
                    <small style="color: #6c757d;">${member.reward_expiry_nearest || 'N/A'}</small>
                </td>
                <td>
                    ${formatDate(member.last_txn_date)}<br>
                    <small style="color: #6c757d;">${member.last_txn_type}</small>
                </td>
                <td>
                    <div class="flags-container">
                        ${member.flag_suspicious ? '<div class="flag flag-suspicious" title="Nghi vấn">!</div>' : ''}
                        ${member.flag_family_plan ? '<div class="flag flag-family" title="Family Plan">F</div>' : ''}
                        ${member.flag_mgm ? '<div class="flag flag-mgm" title="MgM">M</div>' : ''}
                    </div>
                </td>
            `;

            return row;
        }

        // Select member and show detail panel
        function selectMember(member) {
            // Remove previous selection
            document.querySelectorAll('.members-table tbody tr').forEach(row => {
                row.classList.remove('selected');
            });

            // Add selection to clicked row
            event.currentTarget.classList.add('selected');

            currentMember = member;
            showDetailPanel(member);
        }

        // Show detail panel
        function showDetailPanel(member) {
            const panel = document.getElementById('detailPanel');
            const title = document.getElementById('detailTitle');
            const searchBar = document.querySelector('.search-filter-bar');
            
            // Hide search bar and show detail panel
            searchBar.style.display = 'none';
            panel.classList.add('active');
            title.textContent = `${member.full_name} (${member.member_code})`;
            
            // Reset to first tab
            currentTab = 'profile';
            document.querySelectorAll('.detail-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.detail-tab').classList.add('active');
            
            switchTab('profile');
        }

        // Close detail panel
        function closeDetailPanel() {
            const panel = document.getElementById('detailPanel');
            const searchBar = document.querySelector('.search-filter-bar');
            
            // Show search bar and hide detail panel
            searchBar.style.display = 'block';
            panel.classList.remove('active');
            document.querySelectorAll('.members-table tbody tr').forEach(row => {
                row.classList.remove('selected');
            });
            currentMember = null;
        }

        // Switch detail tab
        function switchTab(tabName) {
            if (!currentMember) return;

            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.detail-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Load tab content
            const content = document.getElementById('detailContent');
            content.innerHTML = getTabContent(tabName, currentMember);
        }

        // Get tab content HTML
        function getTabContent(tabName, member) {
            switch (tabName) {
                case 'profile':
                    return `
                        <div class="field-group">
                            <label class="field-label">Họ và tên</label>
                            <div class="field-value">${member.full_name}</div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Giới tính</label>
                            <div class="field-value">${member.gender}</div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Ngày sinh / Loại</label>
                            <div class="field-value">${formatDate(member.dob)} (${member.age} tuổi) - ${member.type}</div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Số điện thoại</label>
                            <div class="field-value">${member.phone ? formatPhone(member.phone) : 'Chưa có SĐT'}</div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Email</label>
                            <div class="field-value">${member.email || 'Chưa có email'}</div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Địa chỉ</label>
                            <div class="field-value">${member.address}</div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Trạng thái</label>
                            <div class="field-value">
                                <span class="status-pill status-${member.status.toLowerCase()}">${member.status}</span>
                            </div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Ngày kích hoạt</label>
                            <div class="field-value">${formatDate(member.start_active_date)}</div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Nguồn tạo</label>
                            <div class="field-value">${member.source}</div>
                        </div>
                        ${member.guardian_member_code ? `
                        <div class="field-group">
                            <label class="field-label">Người bảo hộ</label>
                            <div class="field-value">${member.guardian_member_code}</div>
                        </div>
                        ` : ''}
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="editProfile()">Sửa hồ sơ</button>
                            <button class="btn btn-warning" onclick="sendOTP()">Gửi OTP</button>
                            ${member.status === 'Active' ? 
                                '<button class="btn btn-danger" onclick="suspendMember()">Suspend</button>' :
                                '<button class="btn btn-success" onclick="activateMember()">Kích hoạt</button>'
                            }
                        </div>
                    `;

                case 'points':
                    return `
                        <div class="field-group">
                            <label class="field-label">Hạng hiện tại</label>
                            <div class="field-value">
                                <span class="tier-pill tier-${getTierClass(member.tier)}">${member.tier}</span>
                            </div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Điểm Vàng (12 tháng)</label>
                            <div class="field-value"><strong>${member.points_gold_12m.toLocaleString()}</strong></div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Tiến độ lên hạng</label>
                            <div class="field-value">
                                <div class="progress-container" style="width: 100%; height: 12px; margin-bottom: 5px;">
                                    <div class="progress-bar" style="width: ${member.rank_progress_pct}%"></div>
                                </div>
                                ${member.rank_progress_pct}% - Cần thêm ${member.points_to_next_tier.toLocaleString()} điểm
                            </div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Số tour (12 tháng)</label>
                            <div class="field-value">${member.tours_12m} tour</div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Điểm Thưởng khả dụng</label>
                            <div class="field-value">
                                <strong>${member.points_reward_available.toLocaleString()}</strong>
                                <button class="btn btn-primary" style="margin-left: 10px; padding: 4px 8px; font-size: 11px;" onclick="showRewardPointsDetail('${member.member_code}')">Xem chi tiết</button>
                            </div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Kỳ hết hạn gần nhất</label>
                            <div class="field-value">${member.reward_expiry_nearest || 'N/A'}</div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Ưu đãi theo hạng</label>
                            <div class="field-value">${getTierBenefits(member.tier)}</div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="addGoodwillPoints()">Cộng điểm goodwill</button>
                            <button class="btn btn-danger" onclick="deductPoints()">Trừ điểm</button>
                        </div>
                    `;

                case 'transactions':
                    return `
                        <div class="field-group">
                            <label class="field-label">Giao dịch gần nhất</label>
                            <div class="field-value">
                                ${formatDate(member.last_txn_date)} - ${member.last_txn_type}
                            </div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Lịch sử giao dịch</label>
                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px;">
                                <table style="width: 100%; font-size: 12px;">
                                    <thead style="background: #f8f9fa;">
                                        <tr>
                                            <th style="padding: 8px;">Ngày</th>
                                            <th style="padding: 8px;">Loại</th>
                                            <th style="padding: 8px;">Điểm Vàng</th>
                                            <th style="padding: 8px;">Điểm Thưởng</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="padding: 8px;">${formatDate(member.last_txn_date)}</td>
                                            <td style="padding: 8px;">${member.last_txn_type}</td>
                                            <td style="padding: 8px;">+${Math.floor(Math.random() * 100)}</td>
                                            <td style="padding: 8px;">+${Math.floor(Math.random() * 200)}</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px;">2024-09-15</td>
                                            <td style="padding: 8px;">Tour</td>
                                            <td style="padding: 8px;">+125</td>
                                            <td style="padding: 8px;">+250</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px;">2024-08-22</td>
                                            <td style="padding: 8px;">Vé MB</td>
                                            <td style="padding: 8px;">+45</td>
                                            <td style="padding: 8px;">+90</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="createRetroTour()">Tạo Retro Tour</button>
                            <button class="btn btn-secondary" onclick="createRetroOther()">Retro dịch vụ khác</button>
                        </div>
                    `;

                case 'family':
                    return `
                        <div class="field-group">
                            <label class="field-label">Nhóm gia đình</label>
                            <div class="field-value">${member.family_group_id || 'Chưa tham gia'}</div>
                        </div>
                        ${member.family_group_id ? `
                        <div class="field-group">
                            <label class="field-label">Thành viên trong nhóm</label>
                            <div style="border: 1px solid #dee2e6; border-radius: 6px; padding: 10px;">
                                <div style="margin-bottom: 8px;">
                                    <strong>${member.full_name}</strong> (Tài khoản chính)
                                    <span class="tier-pill tier-${getTierClass(member.tier)}">${member.tier}</span>
                                </div>
                                <div style="margin-bottom: 8px; padding-left: 20px; color: #6c757d;">
                                    Hoàng Văn Em (Con) - <span class="tier-pill tier-vietravel">Vietravel</span>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        <div class="action-buttons">
                            ${!member.family_group_id ? 
                                '<button class="btn btn-success" onclick="createFamilyPlan()">Tạo Family Plan</button>' :
                                '<button class="btn btn-primary" onclick="addFamilyMember()">Thêm thành viên</button>'
                            }
                            ${member.family_group_id ? '<button class="btn btn-warning" onclick="transferPoints()">Tặng điểm</button>' : ''}
                        </div>
                    `;

                case 'rewards':
                    return `
                        <div class="field-group">
                            <label class="field-label">Điểm có thể đổi</label>
                            <div class="field-value"><strong>${member.points_reward_available.toLocaleString()}</strong></div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Danh mục phần thưởng</label>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px;">
                                <table style="width: 100%; font-size: 12px;">
                                    <thead style="background: #f8f9fa;">
                                        <tr>
                                            <th style="padding: 8px; text-align: left;">Loại</th>
                                            <th style="padding: 8px; text-align: left;">Giá trị</th>
                                            <th style="padding: 8px; text-align: left;">Điểm cần</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="padding: 8px;">Voucher Tour 100k</td>
                                            <td style="padding: 8px;">100.000 VND</td>
                                            <td style="padding: 8px;">100 điểm</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px;">Voucher Tour 500k</td>
                                            <td style="padding: 8px;">500.000 VND</td>
                                            <td style="padding: 8px;">500 điểm</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 8px;">Voucher Đối tác 50k</td>
                                            <td style="padding: 8px;">50.000 VND</td>
                                            <td style="padding: 8px;">75 điểm</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Điều kiện trả thưởng</label>
                            <div class="field-value">
                                ${member.type === 'CHD' ? 
                                    '<span style="color: #dc3545;">CHD: Cần hỗ trợ từ nhân viên VTT</span>' : 
                                    '<span style="color: #28a745;">Đủ điều kiện trả thưởng trực tuyến</span>'
                                }
                            </div>
                        </div>
                        <div class="action-buttons">
                            ${member.type === 'ADL' ? 
                                '<button class="btn btn-success" onclick="redeemReward()">Đổi thưởng</button>' :
                                '<button class="btn btn-secondary" onclick="supportRedeem()">Hỗ trợ đổi thưởng</button>'
                            }
                        </div>
                    `;

                case 'security':
                    return `
                        <div class="field-group">
                            <label class="field-label">Trạng thái bảo mật</label>
                            <div class="field-value">
                                <span class="status-pill status-active">Bảo mật tốt</span>
                            </div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Số điện thoại xác thực</label>
                            <div class="field-value">${member.phone ? formatPhone(member.phone) : 'Chưa có SĐT'}</div>
                        </div>
                        <div class="field-group">
                            <label class="field-label">Email xác thực</label>
                            <div class="field-value">${member.email || 'Chưa có email'}</div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="sendOTP()">Gửi OTP</button>
                            <button class="btn btn-warning" onclick="resetPassword()">Đặt lại mật khẩu</button>
                            <button class="btn btn-secondary" onclick="changePhone()">Đổi SĐT</button>
                            <button class="btn btn-secondary" onclick="changeEmail()">Đổi Email</button>
                        </div>
                    `;

                default:
                    return '<div>Tab content not found</div>';
            }
        }

        // Search members
        function searchMembers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredMembers = [...membersData];
            } else {
                filteredMembers = membersData.filter(member => 
                    member.full_name.toLowerCase().includes(searchTerm) ||
                    member.member_code.toLowerCase().includes(searchTerm) ||
                    (member.phone && member.phone.toString().includes(searchTerm))
                );
            }
            
            applyFilters();
        }

        // Apply filters
        function applyFilters() {
            let filtered = [...membersData];
            
            // Search filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(member => 
                    member.full_name.toLowerCase().includes(searchTerm) ||
                    member.member_code.toLowerCase().includes(searchTerm) ||
                    (member.phone && member.phone.toString().includes(searchTerm))
                );
            }
            
            // Status filter
            const statusFilter = document.getElementById('statusFilter').value;
            if (statusFilter) {
                filtered = filtered.filter(member => member.status === statusFilter);
            }
            
            // Type filter
            const typeFilter = document.getElementById('typeFilter').value;
            if (typeFilter) {
                filtered = filtered.filter(member => member.type === typeFilter);
            }
            
            // Tier filter
            const tierFilter = document.getElementById('tierFilter').value;
            if (tierFilter) {
                filtered = filtered.filter(member => member.tier === tierFilter);
            }
            
            // Source filter
            const sourceFilter = document.getElementById('sourceFilter').value;
            if (sourceFilter) {
                filtered = filtered.filter(member => member.source === sourceFilter);
            }
            
            // Flag filter
            const flagFilter = document.getElementById('flagFilter').value;
            if (flagFilter) {
                switch (flagFilter) {
                    case 'suspicious':
                        filtered = filtered.filter(member => member.flag_suspicious);
                        break;
                    case 'family':
                        filtered = filtered.filter(member => member.flag_family_plan);
                        break;
                    case 'mgm':
                        filtered = filtered.filter(member => member.flag_mgm);
                        break;
                    case 'inactive':
                        filtered = filtered.filter(member => member.inactivity_months >= 24);
                        break;
                }
            }
            
            filteredMembers = filtered;
            loadMembers();
        }

        // Update table stats
        function updateTableStats() {
            const total = filteredMembers.length;
            const stats = document.getElementById('tableStats');
            stats.textContent = `Hiển thị 1 - ${total} của ${total} hội viên`;
        }

        // Open create modal
        function openCreateModal() {
            document.getElementById('createModal').classList.add('active');
            clearCreateForm();
        }

        // Close create modal
        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('active');
            clearCreateForm();
        }

        // Clear create form
        function clearCreateForm() {
            document.getElementById('createMemberForm').reset();
            document.querySelectorAll('.validation-error').forEach(error => error.textContent = '');
            document.querySelectorAll('.field-input').forEach(input => input.classList.remove('error'));
            document.getElementById('guardianSection').style.display = 'none';
        }

        // Check age and show guardian section if needed
        function checkAge() {
            const dobInput = document.getElementById('dob');
            const phoneInput = document.getElementById('phone');
            const guardianSection = document.getElementById('guardianSection');
            const guardianInput = document.getElementById('guardianCode');
            
            if (dobInput.value) {
                const birthDate = new Date(dobInput.value);
                const today = new Date();
                const age = today.getFullYear() - birthDate.getFullYear() - 
                           (today < new Date(birthDate.setFullYear(today.getFullYear())) ? 1 : 0);
                
                if (age < 15) {
                    // CHD - show guardian section, phone not required
                    guardianSection.style.display = 'block';
                    phoneInput.required = false;
                    guardianInput.required = true;
                    document.getElementById('phoneNote').textContent = 'Không bắt buộc cho CHD (<15 tuổi)';
                } else {
                    // ADL - hide guardian section, phone required
                    guardianSection.style.display = 'none';
                    phoneInput.required = true;
                    guardianInput.required = false;
                    document.getElementById('phoneNote').textContent = 'Bắt buộc cho ADL (≥15 tuổi). SĐT phải duy nhất.';
                }
            }
        }

        // Validate phone
        function validatePhone() {
            const phoneInput = document.getElementById('phone');
            const phoneError = document.getElementById('phoneError');
            const phone = phoneInput.value.trim();
            
            if (phone && !phone.match(/^[0-9]{10,11}$/)) {
                phoneError.textContent = 'SĐT phải có 10-11 chữ số';
                phoneInput.classList.add('error');
                return false;
            }
            
            // Check duplicate
            if (phone && membersData.find(m => m.phone && m.phone.toString() === phone)) {
                phoneError.textContent = 'SĐT này đã tồn tại trong hệ thống';
                phoneInput.classList.add('error');
                return false;
            }
            
            phoneError.textContent = '';
            phoneInput.classList.remove('error');
            return true;
        }

        // Validate guardian
        function validateGuardian() {
            const guardianInput = document.getElementById('guardianCode');
            const guardianError = document.getElementById('guardianError');
            const guardianCode = guardianInput.value.trim();
            
            if (guardianCode) {
                const guardian = membersData.find(m => m.member_code === guardianCode);
                if (!guardian) {
                    guardianError.textContent = 'Không tìm thấy tài khoản người bảo hộ';
                    guardianInput.classList.add('error');
                    return false;
                }
                
                if (!guardian.email) {
                    guardianError.textContent = 'Tài khoản người bảo hộ phải có email';
                    guardianInput.classList.add('error');
                    return false;
                }
            }
            
            guardianError.textContent = '';
            guardianInput.classList.remove('error');
            return true;
        }

        // Handle create form submission
        document.getElementById('createMemberForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate all fields
            const fullName = document.getElementById('fullName').value.trim();
            const dob = document.getElementById('dob').value;
            const address = document.getElementById('address').value.trim();
            
            let isValid = true;
            
            if (!fullName) {
                document.getElementById('fullNameError').textContent = 'Họ tên là bắt buộc';
                document.getElementById('fullName').classList.add('error');
                isValid = false;
            }
            
            if (!dob) {
                document.getElementById('dobError').textContent = 'Ngày sinh là bắt buộc';
                document.getElementById('dob').classList.add('error');
                isValid = false;
            }
            
            if (!address) {
                document.getElementById('addressError').textContent = 'Địa chỉ là bắt buộc';
                document.getElementById('address').classList.add('error');
                isValid = false;
            }
            
            isValid = validatePhone() && isValid;
            isValid = validateGuardian() && isValid;
            
            if (isValid) {
                // Simulate creating member
                alert('Tài khoản đã được tạo thành công! OTP sẽ được gửi đến SĐT để kích hoạt.');
                closeCreateModal();
            }
        });

        // Utility functions
        function formatPhone(phone) {
            if (!phone) return '';
            const phoneStr = phone.toString();
            return phoneStr.replace(/(\d{3})(\d{3})(\d{4})/, '$1 $2 $3');
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        function getTierClass(tier) {
            const tierMap = {
                'Vietravel': 'vietravel',
                'Bạc': 'silver',
                'Vàng': 'gold',
                'Bạch kim': 'platinum'
            };
            return tierMap[tier] || 'vietravel';
        }

        function getTierBenefits(tier) {
            const benefits = {
                'Vietravel': 'Không có ưu đãi đặc biệt',
                'Bạc': 'Cộng 20% điểm thưởng, Khu vực tiếp đón riêng',
                'Vàng': 'Cộng 50% điểm thưởng, Đưa đón sân bay 2 lần/năm, Phòng chờ',
                'Bạch kim': 'Cộng 100% điểm thưởng, Đưa đón sân bay 4 lần/năm, Nâng hạng phòng, RM riêng'
            };
            return benefits[tier] || 'Không xác định';
        }

        // Action handlers (stub functions)
        function editProfile() { alert('Chức năng sửa hồ sơ'); }
        function sendOTP() { alert('OTP đã được gửi đến SĐT của hội viên'); }
        function suspendMember() { alert('Hội viên đã được suspend'); }
        function activateMember() { alert('Hội viên đã được kích hoạt'); }
        function addGoodwillPoints() { alert('Chức năng cộng điểm goodwill'); }
        function deductPoints() { alert('Chức năng trừ điểm'); }
        function createRetroTour() { alert('Tạo Retro tour'); }
        function createRetroOther() { alert('Tạo Retro dịch vụ khác'); }
        function createFamilyPlan() { alert('Tạo Family Plan'); }
        function addFamilyMember() { alert('Thêm thành viên Family Plan'); }
        function transferPoints() { alert('Chức năng tặng điểm'); }
        function redeemReward() { alert('Chức năng đổi thưởng'); }
        function supportRedeem() { alert('Hỗ trợ đổi thưởng cho CHD'); }
        function resetPassword() { alert('Đặt lại mật khẩu'); }
        function changePhone() { alert('Đổi số điện thoại'); }
        function changeEmail() { alert('Đổi email'); }
        function exportPointsDetail() { alert('Xuất báo cáo chi tiết điểm thưởng ra Excel'); }

        // Show reward points detail popup
        function showRewardPointsDetail(memberCode) {
            const member = membersData.find(m => m.member_code === memberCode);
            if (!member) return;

            const modal = document.getElementById('rewardPointsModal');
            const totalPoints = document.getElementById('totalRewardPoints');
            const tableBody = document.getElementById('rewardPointsDetailTable');
            
            // Set total points
            totalPoints.textContent = member.points_reward_available.toLocaleString() + ' điểm';
            
            // Generate mock data for reward points breakdown
            const rewardPointsData = generateMockRewardPointsData(member.points_reward_available);
            
            // Clear table
            tableBody.innerHTML = '';
            
            // Statistics counters
            let expiring30 = 0, expiring90 = 0, validLongTerm = 0;
            
            // Populate table
            rewardPointsData.forEach(point => {
                const row = document.createElement('tr');
                
                const today = new Date();
                const expiryDate = new Date(point.expiry_date);
                const daysLeft = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                let statusClass = '';
                let statusText = '';
                
                if (daysLeft <= 0) {
                    statusClass = 'style="color: #dc3545; font-weight: bold;"';
                    statusText = 'Đã hết hạn';
                } else if (daysLeft <= 30) {
                    statusClass = 'style="color: #dc3545; font-weight: bold;"';
                    statusText = 'Sắp hết hạn';
                    expiring30 += point.points;
                } else if (daysLeft <= 90) {
                    statusClass = 'style="color: #ffc107; font-weight: bold;"';
                    statusText = 'Cảnh báo';
                    expiring90 += point.points;
                } else {
                    statusClass = 'style="color: #28a745;"';
                    statusText = 'Còn hiệu lực';
                    validLongTerm += point.points;
                }
                
                row.innerHTML = `
                    <td style="padding: 10px 8px; border-bottom: 1px solid #f1f3f4;">${formatDate(point.earned_date)}</td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #f1f3f4; font-weight: bold;">${point.points.toLocaleString()}</td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #f1f3f4;">${formatDate(point.expiry_date)}</td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #f1f3f4;">${daysLeft > 0 ? daysLeft : 0}</td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #f1f3f4;" ${statusClass}>${statusText}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Update statistics
            document.getElementById('expiring30Days').textContent = expiring30.toLocaleString();
            document.getElementById('expiring90Days').textContent = expiring90.toLocaleString();
            document.getElementById('validLongTerm').textContent = validLongTerm.toLocaleString();
            
            // Show modal
            modal.classList.add('active');
        }

        // Close reward points popup
        function closeRewardPointsPopup() {
            document.getElementById('rewardPointsModal').classList.remove('active');
        }

        // Close reward points modal (keep for compatibility)
        function closeRewardPointsModal() {
            document.getElementById('rewardPointsModal').classList.remove('active');
        }

        // Generate mock reward points data with different expiry dates
        function generateMockRewardPointsData(totalPoints) {
            const data = [];
            const today = new Date();
            let remainingPoints = totalPoints;
            
            // Create 8-12 different point entries with various expiry dates
            const numEntries = Math.floor(Math.random() * 5) + 8;
            
            for (let i = 0; i < numEntries && remainingPoints > 0; i++) {
                const isLastEntry = (i === numEntries - 1);
                const points = isLastEntry ? remainingPoints : Math.floor(Math.random() * (remainingPoints * 0.4)) + 50;
                
                // Generate earned date (random within last 36 months)
                const earnedDate = new Date(today);
                const daysAgo = Math.floor(Math.random() * (36 * 30)) + 1; // 1 to 36*30 days ago
                earnedDate.setDate(earnedDate.getDate() - daysAgo);
                
                // Expiry date is 36 months after earned date
                const expiryDate = new Date(earnedDate);
                expiryDate.setMonth(expiryDate.getMonth() + 36);
                
                data.push({
                    earned_date: earnedDate.toISOString().split('T')[0],
                    points: points,
                    expiry_date: expiryDate.toISOString().split('T')[0]
                });
                
                remainingPoints -= points;
            }
            
            // Sort by expiry date (earliest first)
            data.sort((a, b) => new Date(a.expiry_date) - new Date(b.expiry_date));
            
            return data;
        }
        
        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMembers();
            }
        });
    </script>
</body>
</html>